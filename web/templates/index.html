<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathSteer Guardian</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #0a0a0f;
            --panel: #12121a;
            --card: #1a1a2e;
            --border: #2a2a4e;
            --text: #e0e0e0;
            --muted: #666;
            --blue: #00d4ff;
            --purple: #7b2cbf;
            --green: #00ff88;
            --yellow: #ffaa00;
            --orange: #ff6600;
            --red: #ff4444;
            --sl-blue: #1DA1F2;
            --tmo-magenta: #E20074;
            --att-blue: #00A8E0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Mono', 'Fira Code', monospace; 
            background: var(--bg); 
            color: var(--text); 
            font-size: 11px;
            overflow: hidden;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 260px 1fr 280px 260px;
            grid-template-rows: 48px 1fr 160px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, var(--panel), #1a1a30);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 14px; font-weight: 700; letter-spacing: 2px; }
        .logo .g { color: var(--blue); }
        
        .badges { display: flex; gap: 10px; align-items: center; }
        .badge {
            padding: 5px 12px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .mode-training { background: rgba(0,212,255,0.15); color: var(--blue); border: 1px solid var(--blue); }
        .mode-tripwire { background: rgba(255,170,0,0.15); color: var(--yellow); border: 1px solid var(--yellow); }
        .mode-mirror { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid var(--green); }
        .state-normal { background: rgba(0,255,136,0.1); color: var(--green); }
        .state-prepare { background: rgba(255,170,0,0.1); color: var(--yellow); animation: pulse 1.5s infinite; }
        .state-protect { background: rgba(255,102,0,0.15); color: var(--orange); animation: pulse 0.8s infinite; }
        .state-switching { background: rgba(255,68,68,0.15); color: var(--red); animation: pulse 0.5s infinite; }
        .state-holding { background: rgba(123,44,191,0.15); color: var(--purple); }
        .state-offline { background: rgba(100,100,100,0.2); color: #666; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .speed-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--blue);
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        .speed-display .unit { font-size: 11px; color: var(--muted); }
        
        /* Panels */
        .panel { background: var(--panel); padding: 10px; overflow-y: auto; }
        .panel h2 {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--muted);
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Training Banner */
        .training-banner {
            background: repeating-linear-gradient(45deg, var(--card), var(--card) 10px, var(--bg) 10px, var(--bg) 20px);
            border: 2px solid var(--blue);
            padding: 8px;
            text-align: center;
            font-weight: 700;
            color: var(--blue);
            margin-bottom: 10px;
            display: none;
        }
        .training-banner.active { display: block; }
        
        /* Uplink Cards */
        .uplink-card { position: relative;
            background: var(--card);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            border: 2px solid var(--border);
            position: relative;
            transition: all 0.2s;
        }
        .uplink-card.active { border-color: var(--green); box-shadow: 0 0 12px rgba(0,255,136,0.2); }
        .uplink-card.active::after {

            content: '‚óè ACTIVE';
        
            position: absolute;
        
            top: 6px;
        
            right: 8px;
        
            font-size: 8px;
        
            color: var(--green);
        
            animation: blink 1s infinite;
        
        }
        
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .uplink-card.unavailable { opacity: 0.4; }
        .uplink-card[data-rank]::before {
            position: absolute;
            top: 6px;
            right: 50px;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            z-index: 10;
        }
        .uplink-card[data-rank="1"]::before {
            content: "NEXT " attr(data-prob);
            background: var(--yellow);
            color: #000;
        }
        .uplink-card[data-rank="2"]::before {
            content: "2ND " attr(data-prob);
            background: #555;
            color: #ccc;
        }
        .uplink-card[data-rank="3"]::before {
            content: "3RD " attr(data-prob);
            background: #333;
            color: #999;
        }
        .uplink-card.next-best { border-color: var(--yellow); box-shadow: 0 0 8px rgba(247,220,111,0.3); }

        .uplink-card.lte { border-left: 3px solid var(--tmo-magenta); }
        .uplink-card.lte.att { border-left-color: var(--att-blue); }
        .uplink-card.starlink { border-left: 3px solid var(--sl-blue); }
        .uplink-card.fiber { border-left: 3px solid var(--green); }
        
        .uplink-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .uplink-name { font-weight: 700; font-size: 11px; }
        .uplink-type { font-size: 9px; color: var(--muted); }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .metric {
            background: var(--bg);
            padding: 4px;
            border-radius: 2px;
            text-align: center;
        }
        .metric-label { font-size: 8px; color: var(--muted); text-transform: uppercase; }
        .metric-value { font-size: 11px; font-weight: 600; color: var(--blue); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.bad { color: var(--red); }
        
        .sparkline {
            height: 16px;
            background: var(--bg);
            border-radius: 2px;
            margin-top: 4px;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }
        .spark-bar {
            flex: 1;
            background: var(--blue);
            margin: 0 1px;
            min-height: 1px;
            transition: height 0.1s;
        }
        .spark-bar.warn { background: var(--yellow); }
        .spark-bar.bad { background: var(--red); }
        
        .uplink-actions { margin-top: 6px; display: flex; gap: 4px; }
        .btn-fail {
            flex: 1;
            padding: 4px;
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            font-size: 8px;
            border-radius: 2px;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn-fail:hover { background: var(--red); color: var(--bg); }
        
        /* GPS Panel */
        .gps-panel {
            background: var(--card);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .gps-coords { font-family: monospace; color: var(--blue); font-size: 12px; }
        .gps-meta { font-size: 9px; color: var(--muted); margin-top: 4px; }
        
        /* Risk Gauge */
        .risk-panel {
            background: var(--card);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .risk-header { display: flex; justify-content: space-between; align-items: center; }
        .risk-value { font-size: 20px; font-weight: 700; }
        .risk-rec { font-size: 10px; padding: 3px 8px; border-radius: 2px; }
        .risk-bar { height: 6px; background: var(--bg); border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .risk-fill { height: 100%; background: linear-gradient(90deg, var(--green), var(--yellow), var(--red)); transition: width 0.3s; }
        
        /* Map */
        .map-panel { position: relative; }
        #map { height: 100%; background: var(--bg); }
        .map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(18,18,26,0.95);
            padding: 8px;
            border-radius: 4px;
            font-size: 9px;
            z-index: 1000;
        }
        .legend-row { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        
        /* Right Panel */
        .countdown-panel {
            background: linear-gradient(135deg, rgba(255,102,0,0.1), rgba(255,170,0,0.05));
            border: 1px solid var(--orange);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: center;
            display: none;
        }
        .countdown-panel.active { display: block; }
        .countdown-title { font-weight: 700; font-size: 11px; }
        .countdown-trigger { font-size: 9px; color: var(--yellow); margin-top: 4px; }
        .countdown-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
        .countdown-item { text-align: center; }
        .countdown-num { font-size: 22px; font-weight: 700; color: var(--orange); }
        .countdown-label { font-size: 8px; color: var(--muted); text-transform: uppercase; }
        
        .flap-banner {
            background: rgba(123,44,191,0.2);
            border: 1px solid var(--purple);
            padding: 6px;
            border-radius: 4px;
            text-align: center;
            font-size: 9px;
            color: var(--purple);
            margin-bottom: 8px;
            display: none;
        }
        .flap-banner.active { display: block; }
        
        /* Controls */
        .control-group { margin-bottom: 10px; }
        .btn-row { display: flex; gap: 4px; }
        .btn {
            flex: 1;
            padding: 8px 4px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 9px;
            font-weight: 600;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn:hover { background: var(--border); }
        .btn.active { background: var(--blue); color: var(--bg); border-color: var(--blue); }
        .btn.danger { border-color: var(--red); color: var(--red); }
        .btn.danger:hover { background: var(--red); color: var(--bg); }
        .btn-wide { width: 100%; }
        
        /* Decision Feed */
        .feed { max-height: 200px; overflow-y: auto; }
        .feed-item {
            background: var(--card);
            padding: 6px;
            margin-bottom: 3px;
            border-radius: 3px;
            font-size: 9px;
            border-left: 2px solid var(--border);
        }
        .feed-item.tripwire { border-left-color: var(--orange); background: rgba(255,102,0,0.05); }
        .feed-item.switch { border-left-color: var(--purple); }
        .feed-item.predict { border-left-color: var(--blue); }
        .feed-item.mode { border-left-color: var(--green); }
        .feed-time { color: var(--muted); font-size: 8px; }
        .feed-msg { margin-top: 2px; }
        .feed-reason { color: var(--yellow); }
        
        /* Controller Panel */
        .controller-panel {
            background: var(--card);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; margin: 4px 0; }
        .ctrl-label { font-size: 9px; color: var(--muted); }
        .ctrl-value { font-size: 10px; color: var(--blue); }
        .ctrl-value.active { color: var(--green); }
        
        /* Remote Targets */
        .targets-panel { font-size: 9px; color: var(--muted); }
        .target-row { display: flex; justify-content: space-between; margin: 2px 0; }
        .target-status { color: var(--green); }
        .target-status.offline { color: var(--red); }

        /* Event Log Panel */
        .event-log {
            grid-column: 1 / -1;
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .event-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
        }
        .event-log-header h3 {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
        }
        .event-log-controls {
            display: flex;
            gap: 8px;
        }
        .event-log-controls button {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 2px 8px;
            font-size: 9px;
            cursor: pointer;
            border-radius: 2px;
        }
        .event-log-controls button:hover { border-color: var(--blue); color: var(--blue); }
        .event-log-controls button.active { border-color: var(--blue); color: var(--blue); background: rgba(0,212,255,0.1); }
        .event-log-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
            font-family: monospace;
            font-size: 10px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(42,42,78,0.3);
            display: flex;
            gap: 12px;
        }
        .log-time { color: var(--muted); min-width: 90px; }
        .log-level { min-width: 60px; font-weight: 600; }
        .log-level.info { color: var(--blue); }
        .log-level.warn { color: var(--yellow); }
        .log-level.error { color: var(--red); }
        .log-level.switch { color: var(--green); }
        .log-level.trigger { color: var(--orange); }
        .log-msg { color: var(--text); flex: 1; }
        .log-gps { color: var(--muted); font-size: 9px; }

        /* Signal Bars */
        .signal-bars {
            display: inline-flex;
            align-items: flex-end;
            gap: 1px;
            height: 12px;
            margin-left: 4px;
            vertical-align: middle;
        }
        .signal-bar {
            width: 3px;
            background: var(--muted);
            border-radius: 1px;
        }
        .signal-bar.active { background: var(--green); }
        .signal-bar.warn { background: var(--yellow); }
        .signal-bar.bad { background: var(--red); }
        .signal-bar:nth-child(1) { height: 3px; }
        .signal-bar:nth-child(2) { height: 5px; }
        .signal-bar:nth-child(3) { height: 8px; }
        .signal-bar:nth-child(4) { height: 11px; }
        
        /* Obstruction Indicator */
        .obstr-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
        }
        .obstr-indicator.clear { background: var(--green); box-shadow: 0 0 4px var(--green); }
        .obstr-indicator.obstructed { background: var(--red); box-shadow: 0 0 4px var(--red); animation: pulse 0.5s infinite; }

        /* Signal Bars */
        .signal-bars {
            display: inline-flex;
            align-items: flex-end;
            gap: 1px;
            height: 12px;
            margin-left: 4px;
            vertical-align: middle;
        }
        .signal-bar {
            width: 3px;
            background: var(--muted);
            border-radius: 1px;
        }
        .signal-bar.active { background: var(--green); }
        .signal-bar.warn { background: var(--yellow); }
        .signal-bar.bad { background: var(--red); }
        .signal-bar:nth-child(1) { height: 3px; }
        .signal-bar:nth-child(2) { height: 5px; }
        .signal-bar:nth-child(3) { height: 8px; }
        .signal-bar:nth-child(4) { height: 11px; }
        
        /* Obstruction Indicator */
        .obstr-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
        }
        .obstr-indicator.clear { background: var(--green); box-shadow: 0 0 4px var(--green); }
        .obstr-indicator.obstructed { background: var(--red); box-shadow: 0 0 4px var(--red); animation: pulse 0.5s infinite; }

        /* Stats Panel */
        .stats-panel {
            background: var(--panel);
            padding: 10px;
            overflow-y: auto;
        }
        .stat-card {
            background: var(--card);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .stat-card h3 {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--muted); font-size: 10px; }
        .stat-value { color: var(--blue); font-size: 11px; font-weight: 600; }
        .stat-value.good { color: var(--green); }
        .stat-value.warn { color: var(--yellow); }
        .stat-value.bad { color: var(--red); }
        
        .big-stat {
            text-align: center;
            padding: 12px;
        }
        .big-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--blue);
        }
        .big-stat-label {
            font-size: 9px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .throughput-bar {
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }
        .throughput-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--green));
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 240px 1fr 240px;
                grid-template-rows: 48px 1fr 140px;
            }
            .stats-panel { display: none; }
        }
        
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 48px auto auto auto 120px;
            }
            .header { 
                grid-column: 1; 
                flex-wrap: wrap;
                padding: 8px;
                height: auto;
            }
            .panel.left-panel {
                grid-column: 1;
                grid-row: auto;
                max-height: 300px;
            }
            .panel.map-panel {
                grid-column: 1;
                grid-row: auto;
                min-height: 250px;
            }
            .stats-panel {
                display: none;
            }
            .panel:last-of-type {
                grid-column: 1;
                grid-row: auto;
                max-height: 250px;
            }
            .event-log {
                grid-column: 1;
                height: 120px;
            }
            .uplink-card { position: relative;
                padding: 6px;
                margin-bottom: 4px;
            }
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 2px;
            }
            .metric {
                padding: 2px;
            }
            .metric-label { font-size: 7px; }
            .metric-value { font-size: 9px; }
            .sparkline { display: none; }
            .uplink-actions { display: none; }
            .btn { padding: 6px 10px; font-size: 9px; }
            .speed-display { font-size: 18px; }
            .logo h1 { font-size: 12px; }
        }
        
        
            .badges { 
                gap: 4px;
            }
            .badge {
                padding: 3px 6px;
                font-size: 8px;
            }
            #node-id { display: none; }
            .panel.left-panel {
                max-height: 250px;
            }
            .panel.map-panel {
                min-height: 200px;
            }
            .uplink-card { position: relative;
                padding: 4px;
            }
            .uplink-header {
                margin-bottom: 3px;
            }
            .uplink-name { font-size: 10px; }
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .gps-panel, .risk-panel { display: none; }
            .map-legend { display: none; }
            .event-log-controls button {
                padding: 2px 4px;
                font-size: 8px;
            }
            .log-entry {
                font-size: 9px;
                gap: 6px;
            }
            .log-time { min-width: 70px; }
            .log-level { min-width: 50px; }
        }

        
        /* Enhanced Mobile Styles */
        @media (max-width: 600px) {
            .dashboard {
                display: flex;
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }
            .header {
                position: sticky;
                top: 0;
                z-index: 100;
                padding: 6px 10px;
                flex-wrap: nowrap;
                gap: 6px;
                background: var(--bg);
                min-height: 44px;
            }
            .logo h1 { font-size: 11px; white-space: nowrap; }
            .speed-display { 
                font-size: 20px; 
                font-weight: bold;
            }
            .badges { 
                display: flex;
                gap: 4px;
                flex-shrink: 0;
            }
            .badge { padding: 3px 6px; font-size: 9px; }
            
            /* Uplink cards section - scrollable */
            .panel.left-panel {
                flex: 1 1 auto;
                min-height: 200px;
                max-height: 50vh;
                overflow-y: scroll;
                padding: 8px;
                -webkit-overflow-scrolling: touch;
            }
            .uplink-card {
                padding: 10px;
                margin-bottom: 6px;
            }
            .uplink-header {
                margin-bottom: 6px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .uplink-name { font-size: 14px; font-weight: bold; }
            .uplink-toggle {
                width: 44px;
                height: 24px;
                min-width: 44px;
            }
            .uplink-toggle::after {
                width: 18px;
                height: 18px;
            }
            .uplink-toggle.enabled::after { left: 22px; }
            
            /* Metrics - 2 column grid, visible values */
            .metrics-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 6px !important;
            }
            .metric {
                padding: 6px !important;
                background: rgba(0,0,0,0.4) !important;
                border-radius: 4px;
                text-align: center;
                min-height: 36px;
            }
            .metric-label { 
                font-size: 9px !important; 
                display: block !important; 
                margin-bottom: 3px; 
                color: var(--muted);
            }
            .metric-value { 
                font-size: 14px !important; 
                font-weight: bold !important; 
                display: block !important; 
            }
            
            /* Hide non-essential */
            .sparkline { display: none !important; }
            .uplink-actions { display: none !important; }
            .stats-panel { display: none !important; }
            .map-legend { display: none !important; }
            .risk-panel { display: none !important; }
            
            /* Map compact */
            .panel.map-panel {
                flex: 0 0 180px;
                min-height: 180px;
            }
            
            /* Right panel - prediction */
            .panel.right-panel {
                flex: 0 0 auto;
                padding: 8px;
            }
            .panel.right-panel h3 { font-size: 11px; margin-bottom: 6px; }
            .stat-row { padding: 3px 0; }
            .stat-label { font-size: 10px; }
            .stat-value { font-size: 12px; }
            
            /* Mode buttons */
            .mode-panel { padding: 8px; }
            .mode-panel h3 { font-size: 10px; }
            .mode-buttons { gap: 6px; }
            .mode-buttons .btn { padding: 8px 12px; font-size: 11px; }
            
            /* Event log minimal */
            .event-log {
                flex: 0 0 100px;
                font-size: 9px;
            }
            .log-time { display: none; }
            .log-level { min-width: 50px; font-size: 9px; }
            .log-msg { font-size: 9px; }
        }
        
        /* Very small phones */
        @media (max-width: 400px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .header { padding: 4px; }
            .uplink-card { padding: 8px; }
        }

        /* Uplink Enable Toggle */
        .uplink-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 16px;
            background: var(--red);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .uplink-toggle.enabled { background: var(--green); }
        .uplink-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s;
        }
        .uplink-toggle.enabled::after { left: 18px; }
        .uplink-card { position: relative; }
        .uplink-card.disabled { opacity: 0.4; }

        /* Chaos Panel */
        .chaos-panel {
            background: var(--card);
            border: 1px solid var(--red);
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .chaos-panel h3 {
            color: var(--red);
            font-size: 10px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .chaos-slider {
            width: 100%;
            margin: 4px 0;
        }
        .chaos-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            font-size: 10px;
        }
        .chaos-value {
            color: var(--orange);
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }
        .chaos-btn {
            background: var(--red);
            border: none;
            color: white;
            padding: 6px 12px;
            font-size: 9px;
            cursor: pointer;
            border-radius: 3px;
            width: 100%;
            margin-top: 8px;
        }
        .chaos-btn:hover { background: #ff4444; }
        .chaos-btn.active { animation: pulse 0.5s infinite; }
    </style>
</head>
<body>
<div class="dashboard">
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <h1>PATHSTEER <span class="g">GUARDIAN</span></h1>
        </div>
        <div class="speed-display">
            <span id="speed-val">0</span>
            <span class="unit">mph</span>
        </div>
        <div class="badges">
            <span class="badge mode-tripwire" id="mode-badge">TRIPWIRE</span>
            <span class="badge state-normal" id="state-badge">NORMAL</span>
            <span style="font-size:9px;color:var(--muted)" id="node-id">--</span>
        <button onclick="window.open('/demo', 'chaos', 'width=1200,height=800,scrollbars=yes')" style="background:linear-gradient(135deg,#ff6b35,#f39c12);border:none;padding:8px 15px;border-radius:6px;cursor:pointer;font-weight:bold;color:#000;margin-left:10px;">üéõÔ∏è CHAOS</button>
        <button onclick="window.location.href='/settings'" style="background:#2a3a4a;border:1px solid #4ecdc4;padding:8px 15px;border-radius:6px;cursor:pointer;font-weight:bold;color:#4ecdc4;margin-left:5px;">‚öôÔ∏è</button>
        </div>
    </header>
    
    <!-- Left: Uplinks -->
    <div class="panel">
        <div class="training-banner" id="training-banner">‚ö† TRAINING MODE ‚Äî NO ACTUATION</div>
        
        <h2>Uplinks</h2>
        <div id="uplinks"></div>
        
        <h2>GPS</h2>
        <div class="gps-panel">
            <div class="gps-coords" id="gps-coords">--.------, --.------</div>
            <div class="gps-meta">
                Heading: <span id="gps-heading">--</span>¬∞ | Alt: <span id="gps-alt">--</span>m
            </div>
        </div>
        
        <h2>Global Risk</h2>
        <div class="risk-panel">
            <div class="risk-header">
                <span class="risk-value" id="risk-pct">0%</span>
                <span class="risk-rec" id="risk-rec" style="background:rgba(0,255,136,0.2);color:var(--green)">NORMAL</span>
            </div>
            <div class="risk-bar"><div class="risk-fill" id="risk-fill" style="width:0%"></div></div>
        </div>
    </div>
    
    <!-- Center: Map -->
    <div class="panel map-panel">
        <div id="map"></div>
        <div class="map-legend">
            <div style="font-weight:600;margin-bottom:4px">Signal Map</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--sl-blue)"></div> Starlink</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--tmo-magenta)"></div> T-Mobile</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--att-blue)"></div> AT&T</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--red)"></div> High Risk Zone</div>
        </div>
    </div>

    <!-- Stats Panel -->
    <div class="stats-panel">
        <div class="stat-card">
            <h3>Session Stats</h3>
            <div class="big-stat">
                <div class="big-stat-value" id="active-sessions">0</div>
                <div class="big-stat-label">Active Sessions</div>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Throughput</h3>
            <div class="stat-row">
                <span class="stat-label">Download</span>
                <span class="stat-value" id="throughput-down">0 Mbps</span>
            </div>
            <div class="throughput-bar"><div class="throughput-fill" id="throughput-down-bar" style="width:0%"></div></div>
            <div class="stat-row" style="margin-top:8px">
                <span class="stat-label">Upload</span>
                <span class="stat-value" id="throughput-up">0 Mbps</span>
            </div>
            <div class="throughput-bar"><div class="throughput-fill" id="throughput-up-bar" style="width:0%"></div></div>
        </div>
        
        <div class="stat-card">
            <h3>Protection Events</h3>
            <div class="stat-row">
                <span class="stat-label">Tripwires (24h)</span>
                <span class="stat-value" id="stat-tripwires">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Switches (24h)</span>
                <span class="stat-value" id="stat-switches">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg Switch Time</span>
                <span class="stat-value good" id="stat-switch-time">--</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Path Quality</h3>
            <div class="stat-row">
                <span class="stat-label">Best Path</span>
                <span class="stat-value good" id="stat-best-path">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Worst Path</span>
                <span class="stat-value warn" id="stat-worst-path">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Path Diversity</span>
                <span class="stat-value" id="stat-diversity">6/6</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Path Prediction</h3>
            <div class="stat-row">
                <span class="stat-label">Active</span>
                <span class="stat-value good" id="pred-active">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Next Best</span>
                <span class="stat-value" id="pred-next" style="color:var(--yellow)">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">2nd</span>
                <span class="stat-value" id="pred-2nd" style="color:#888">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">3rd</span>
                <span class="stat-value" id="pred-3rd" style="color:#666">--</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Uptime</h3>
            <div class="stat-row">
                <span class="stat-label">Session</span>
                <span class="stat-value" id="stat-uptime">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Availability</span>
                <span class="stat-value good" id="stat-availability">100%</span>
            </div>
        </div>
    </div>

    <!-- Right: Controls & Status -->
    <div class="panel">
        <div class="flap-banner" id="flap-banner">‚ö° FLAP SUPPRESSED ‚Äî Max switches reached</div>
        
        <div class="countdown-panel" id="countdown-panel">
            <div class="countdown-title">PROTECTION ACTIVE</div>
            <div class="countdown-trigger">Trigger: <span id="trigger-reason">--</span></div>
            <div class="countdown-grid">
                <div class="countdown-item">
                    <div class="countdown-num" id="cd-hold">8</div>
                    <div class="countdown-label">Hold</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-num" id="cd-clean">5</div>
                    <div class="countdown-label">Clean</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-num" id="cd-switches">0</div>
                    <div class="countdown-label">Switches</div>
                </div>
            </div>
        </div>
        
        <h2>Mode</h2>
        <div class="control-group">
            <div class="btn-row">
                <button class="btn" id="btn-training" onclick="setMode('training')">TRAINING</button>
                <button class="btn active" id="btn-tripwire" onclick="setMode('tripwire')">TRIPWIRE</button>
                <button class="btn" id="btn-mirror" onclick="setMode('mirror')">MIRROR</button>
            </div>
        </div>
        
        <h2>Manual Trigger</h2>
        <div class="control-group">
            <button class="btn btn-wide danger" onclick="triggerProtection()">‚ö° TRIGGER PROTECTION NOW</button>
        </div>
        
        <h2>Controller</h2>
        <div class="controller-panel">
            <div class="ctrl-row">
                <span class="ctrl-label">Active:</span>
                <span class="ctrl-value active" id="ctrl-active">Controller A</span>
            </div>
            <div class="ctrl-row">
                <span class="ctrl-label">C8000:</span>
                <span class="ctrl-value" id="ctrl-c8000">pop-dal.pathsteernetworks.com</span>
            </div>
            <div class="btn-row" style="margin-top:6px">
                <button class="btn" onclick="switchController(0)">CTRL-A</button>
                <button class="btn" onclick="switchController(1)">CTRL-B</button>
            </div>
        </div>
        
        <h2>Decision Feed</h2>
        <div class="feed" id="feed">
            <div class="feed-item predict">
                <div class="feed-time">--:--:--.---</div>
                <div class="feed-msg">Waiting for events...</div>
            </div>
        </div>
        
        <h2 style="margin-top:10px">Remote Targets</h2>
        <div class="targets-panel">
            <div class="target-row" style="cursor:pointer" onclick="flowFloat()">
                <span>Flows: üîç</span>
                <span class="target-status" id="target-voice"><span id="flow-count" style="color:var(--green)">0</span> active</span>
            </div>
            <div style="font-size:8px;color:var(--muted)">
                <span>SIP: <span id="sip-count" style="color:var(--blue)">0</span></span>
                <span style="margin-left:6px">Failovers: <span id="flow-failovers" style="color:var(--yellow)">0</span></span>
            </div>
            </div>
            <div id="llm-panel" style="margin-top:5px;padding:5px;background:var(--bg);border-radius:4px">
                <div class="target-row">
                    <span style="cursor:pointer" onclick="llmFloat()">LLM: üîç</span>
                    <span class="target-status" id="target-llm" style="color:var(--muted)">Stopped</span>
                </div>
                <input type="text" id="llm-prompt" value="Write a poem about network resilience" style="width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);padding:4px;font-size:9px;margin:4px 0;font-family:inherit;border-radius:3px">
                <div style="display:flex;gap:4px;margin:3px 0">
                    <select id="llm-loops" style="flex:1;background:var(--card);color:var(--text);border:1px solid var(--border);font-size:8px;font-family:inherit;padding:2px">
                        <option value="0">Continuous</option>
                        <option value="5">5 loops</option>
                        <option value="10">10 loops</option>
                        <option value="50">50 loops</option>
                        <option value="100">100 loops</option>
                    </select>
                    <button id="llm-start-btn" onclick="llmStart()" style="flex:1;background:var(--green);color:var(--bg);border:none;padding:3px;font-size:8px;font-family:inherit;cursor:pointer;border-radius:2px;font-weight:bold">START</button>
                    <button onclick="llmStop()" style="flex:1;background:var(--red);color:white;border:none;padding:3px;font-size:8px;font-family:inherit;cursor:pointer;border-radius:2px;font-weight:bold">STOP</button>
                </div>
                <div style="font-size:8px;color:var(--muted);margin-top:3px">
                    <div>Tokens/s: <span id="llm-tps" style="color:var(--blue)">0</span> | Total: <span id="llm-total" style="color:var(--green)">0</span> | Reqs: <span id="llm-reqs" style="color:var(--text)">0</span> | Err: <span id="llm-errs" style="color:var(--red)">0</span></div>
                    <div style="margin-top:2px;color:var(--muted);max-height:80px;overflow-y:auto;line-height:1.4;padding:3px;background:var(--card);border-radius:2px;margin-top:3px" id="llm-response" onclick="llmFloat()" style="cursor:pointer" title="Click to expand">--</div>
                </div>
            </div>
        </div>
        
        <h2 style="margin-top:10px">Run</h2>
        <div style="font-size:9px">
            <div style="color:var(--muted)">ID: <span style="color:var(--blue)" id="run-id">--</span></div>
            <div style="color:var(--muted)">Dup: <span id="dup-status" style="color:var(--muted)">OFF</span></div>
        </div>
    </div>

    <!-- Event Log Panel -->
    <div class="event-log">
        <div class="event-log-header">
            <h3>Event Log</h3>
            <div class="event-log-controls">
                <button class="active" onclick="filterLog('all')">ALL</button>
                <button onclick="filterLog('trigger')">TRIGGERS</button>
                <button onclick="filterLog('switch')">SWITCHES</button>
                <button onclick="filterLog('error')">ERRORS</button>
                <button onclick="exportLog()" style="border-color:var(--green);color:var(--green)">EXPORT</button>
            </div>
        </div>
        <div class="event-log-content" id="event-log-content">
            <div class="log-entry">
                <span class="log-time">--:--:--.---</span>
                <span class="log-level info">INFO</span>
                <span class="log-msg">Waiting for events...</span>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
// Update stats from status
function updateStats(s) {
    // Find best/worst RTT
    const available = (s.uplinks || []).filter(u => u.enabled && u.available);
    if (available.length > 0) {
        const sorted = [...available].sort((a,b) => (a.rtt_ms||999) - (b.rtt_ms||999));
        document.getElementById('stat-best-path').textContent = sorted[0].name.toUpperCase() + ' (' + (sorted[0].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-worst-path').textContent = sorted[sorted.length-1].name.toUpperCase() + ' (' + (sorted[sorted.length-1].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-diversity').textContent = available.length + '/' + (s.uplinks||[]).filter(u=>u.enabled).length;
        
        // Path Prediction update
        const activeUplink = (s.uplinks || []).find(u => u.active);
        const nonActive = available.filter(u => !u.active);
        const scored = nonActive.map(u => ({
            name: u.name,
            score: (u.rtt_ms || 999) + (u.risk_now || 0) * 100 + (u.loss_pct || 0) * 10
        })).sort((a, b) => a.score - b.score);
        
        const totalInv = scored.reduce((s, x) => s + 1000/(x.score+1), 0);
        const probs = scored.map(x => ({ name: x.name, prob: Math.round((1000/(x.score+1))/totalInv*100) }));
        
        document.getElementById('pred-active').textContent = activeUplink ? activeUplink.name.toUpperCase() : '--';
        document.getElementById('pred-next').textContent = probs[0] ? probs[0].name.toUpperCase() + ' (' + probs[0].prob + '%)' : '--';
        document.getElementById('pred-2nd').textContent = probs[1] ? probs[1].name.toUpperCase() + ' (' + probs[1].prob + '%)' : '--';
        document.getElementById('pred-3rd').textContent = probs[2] ? probs[2].name.toUpperCase() + ' (' + probs[2].prob + '%)' : '--';
    }
    
    // Throughput (placeholder - would come from actual traffic stats)
    const downMbps = s.throughput_down_mbps || 0;
    const upMbps = s.throughput_up_mbps || 0;
    document.getElementById('throughput-down').textContent = downMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-up').textContent = upMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-down-bar').style.width = Math.min(100, downMbps) + '%';
    document.getElementById('throughput-up-bar').style.width = Math.min(100, upMbps * 2) + '%';
    
    // Session uptime
    if (s.run_id) {
        const parts = s.run_id.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
        const start = parts ? new Date(parts[1], parts[2]-1, parts[3], parts[4], parts[5], parts[6]) : new Date();
        const now = new Date();
        const mins = Math.floor((now - start) / 60000);
        const hrs = Math.floor(mins / 60);
        document.getElementById('stat-uptime').textContent = hrs + 'h ' + (mins % 60) + 'm';
    }
}
</script>
<script>
// Map init
const map = L.map('map').setView([32.7767, -96.7970], 13);  // Dallas default
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '¬© OSM ¬© CARTO', maxZoom: 19
}).addTo(map);
let posMarker = null;
let trail = [];
const trailLine = L.polyline([], {color: '#00d4ff', weight: 2, opacity: 0.6}).addTo(map);

// Heatmap layer
let heatLayer = null;
async function loadHeatmap() {
    try {
        const resp = await fetch("/api/heatmap?hours=720");
        const data = await resp.json();
        if (data && data.length > 0) {
            const points = data.map(p => [p.lat, p.lng, Math.min(p.rtt/50, 1)]);
            if (heatLayer) map.removeLayer(heatLayer);
            heatLayer = L.heatLayer(points, {radius:20, blur:15, maxZoom:17}).addTo(map);
            console.log("Heatmap loaded:", data.length, "points");
        }
    } catch(e) { console.log("Heatmap error:", e); }
}
setTimeout(loadHeatmap, 2000);
setInterval(loadHeatmap, 30000);

// Signal markers with popups
let markerLayer = null;
const uplinkColors = {
    "cell_a": "#E20074",  // T-Mobile magenta
    "cell_b": "#00A8E0",  // AT&T blue
    "sl_a": "#1DA1F2",    // Starlink
    "sl_b": "#1DA1F2",
    "fa": "#00ff88",      // Fiber green
    "fb": "#00ff88",
    "fiber2": "#00ff88"
};
async function loadMarkers() {
    try {
        const resp = await fetch("/api/heatmap?hours=720");
        const data = await resp.json();
        if (markerLayer) map.removeLayer(markerLayer);
        const markers = data.filter(p => ["cell_a","cell_b","sl_a","sl_b"].includes(p.uplink)).slice(-200).map(p => {
            const color = uplinkColors[p.uplink] || "#fff";
            return L.circleMarker([p.lat, p.lng], {
                radius: 5, fillColor: color, color: "#000", 
                weight: 1, fillOpacity: 0.7
            }).bindPopup(
                "<b>" + p.uplink + "</b><br>" +
                "RTT: " + (p.rtt||0).toFixed(1) + "ms<br>" +
                "RSRP: " + (p.rsrp||0) + "<br>" +
                "SINR: " + (p.sinr||0)
            );
        });
        markerLayer = L.layerGroup(markers).addTo(map);
    } catch(e) { console.log("Marker error:", e); }
}
setTimeout(loadMarkers, 3000);
setInterval(loadMarkers, 30000);

// Sparkline data
const sparkData = {};

// Signal bar helper
function getSignalBars(rsrp) {
    const bars = 4;
    let active = 0;
    let cls = 'active';
    if (rsrp >= -80) { active = 4; cls = 'active'; }
    else if (rsrp >= -90) { active = 3; cls = 'active'; }
    else if (rsrp >= -100) { active = 2; cls = 'warn'; }
    else if (rsrp >= -110) { active = 1; cls = 'bad'; }
    else { active = 0; cls = 'bad'; }
    
    let html = '<span class="signal-bars">';
    for (let i = 0; i < bars; i++) {
        html += `<span class="signal-bar ${i < active ? cls : ''}"></span>`;
    }
    html += '</span>';
    return html;
}

// Signal bar helper
function getSignalBars(rsrp) {
    const bars = 4;
    let active = 0;
    let cls = 'active';
    if (rsrp >= -80) { active = 4; cls = 'active'; }
    else if (rsrp >= -90) { active = 3; cls = 'active'; }
    else if (rsrp >= -100) { active = 2; cls = 'warn'; }
    else if (rsrp >= -110) { active = 1; cls = 'bad'; }
    else { active = 0; cls = 'bad'; }
    
    let html = '<span class="signal-bars">';
    for (let i = 0; i < bars; i++) {
        html += `<span class="signal-bar ${i < active ? cls : ''}"></span>`;
    }
    html += '</span>';
    return html;
}

let _uplinkInteractionLock = 0;

function renderUplinks(uplinks) {
    // Skip re-render if user just clicked (prevents DOM destroy during click)
    if (Date.now() < _uplinkInteractionLock) return;
    console.log("renderUplinks called with", uplinks.length, "uplinks");
    const container = document.getElementById('uplinks');
    container.innerHTML = '';
    
    // Calculate scores for next-best prediction
    const scores = uplinks.filter(u => u.enabled && u.available && !u.active).map(u => {
        // Score: lower is better (like daemon logic)
        const score = (u.rtt_ms || 999) + (u.risk_now || 0) * 100 + (u.loss_pct || 0) * 10;
        return { name: u.name, score };
    }).sort((a, b) => a.score - b.score);
    
    // Calculate probabilities (inverse of score, normalized)
    const totalInvScore = scores.reduce((sum, s) => sum + (1000 / (s.score + 1)), 0);
    const nextBest = {};
    console.log("Scores:", scores);
    scores.forEach((s, i) => {
    console.log("nextBest:", nextBest);
        const prob = Math.round(((1000 / (s.score + 1)) / totalInvScore) * 100);
    console.log("nextBest:", nextBest);
        nextBest[s.name] = { rank: i + 1, prob };
    console.log("nextBest:", nextBest);
    });
    console.log("nextBest:", nextBest);

    uplinks.forEach(u => {
        
        const typeClass = u.name.startsWith('cell') ? 'lte' : 
                         u.name.startsWith('sl') ? 'starlink' : 'fiber';
        const carrierClass = u.cellular?.carrier === 'AT&T' ? 'att' : '';
        const activeClass = u.active ? 'active' : (nextBest[u.name]?.rank === 1 ? 'next-best' : '');
        const availClass = u.available ? '' : 'unavailable';
        
        // Update sparkline data
        if (!sparkData[u.name]) sparkData[u.name] = [];
        sparkData[u.name].push(u.rtt_ms || 0);
        if (sparkData[u.name].length > 30) sparkData[u.name].shift();
        
        let metricsHtml = '';
        if (u.name.startsWith('cell')) {
            metricsHtml = `
                <div class="metric"><div class="metric-label">RTT</div><div class="metric-value ${u.rtt_ms > 100 ? 'warn' : ''}">${(u.rtt_ms||0).toFixed(0)}ms</div></div>
                <div class="metric"><div class="metric-label">RSRP${getSignalBars(u.cellular?.rsrp||0)}</div><div class="metric-value ${(u.cellular?.rsrp||0) < -100 ? 'warn' : ''}">${(u.cellular?.rsrp||0).toFixed(0)}</div></div>
                <div class="metric"><div class="metric-label">SINR</div><div class="metric-value">${(u.cellular?.sinr||0).toFixed(1)}</div></div>
                <div class="metric"><div class="metric-label">Loss</div><div class="metric-value ${u.loss_pct > 2 ? 'bad' : ''}">${(u.loss_pct||0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">Carrier</div><div class="metric-value">${u.cellular?.carrier||'--'}</div></div>
                <div class="metric"><div class="metric-label">Risk</div><div class="metric-value ${u.risk_now > 0.5 ? 'warn' : ''}">${((u.risk_now||0)*100).toFixed(0)}%</div></div>
            `;
        } else if (u.name.startsWith('sl')) {
            metricsHtml = `
                <div class="metric"><div class="metric-label">RTT</div><div class="metric-value ${u.rtt_ms > 80 ? 'warn' : ''}">${(u.rtt_ms||0).toFixed(0)}ms</div></div>
                <div class="metric"><div class="metric-label">State</div><div class="metric-value">${u.starlink?.state?.slice(0,6)||'--'}</div></div>
                <div class="metric"><div class="metric-label">OBSTR<span class="obstr-indicator ${u.starlink?.obstruction_pct > 5 ? 'obstructed' : 'clear'}"></span></div><div class="metric-value ${u.starlink?.obstructed ? 'bad' : ''}">${(u.starlink?.obstruction_pct || 0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">Loss</div><div class="metric-value ${u.loss_pct > 2 ? 'bad' : ''}">${(u.loss_pct||0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">ETA</div><div class="metric-value">${u.starlink?.eta > 0 ? u.starlink.eta + 's' : '--'}</div></div>
                <div class="metric"><div class="metric-label">Risk</div><div class="metric-value ${u.risk_now > 0.5 ? 'warn' : ''}">${((u.risk_now||0)*100).toFixed(0)}%</div></div>
            `;
        } else {
            metricsHtml = `
                <div class="metric"><div class="metric-label">RTT</div><div class="metric-value">${(u.rtt_ms||0).toFixed(0)}ms</div></div>
                <div class="metric"><div class="metric-label">Loss</div><div class="metric-value">${(u.loss_pct||0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">Risk</div><div class="metric-value">${((u.risk_now||0)*100).toFixed(0)}%</div></div>
            `;
        }
        
        // Sparkline bars
        const sparkHtml = sparkData[u.name].map(v => {
            const h = Math.max(1, Math.min(14, v / 10));
            const cls = v > 150 ? 'bad' : v > 80 ? 'warn' : '';
            return `<div class="spark-bar ${cls}" style="height:${h}px"></div>`;
        }).join('');
        
        const card = document.createElement('div');
        card.className = `uplink-card ${typeClass} ${carrierClass} ${activeClass} ${availClass}`;
        card.setAttribute('data-name', u.name);
        if (nextBest[u.name]) {
            card.setAttribute('data-rank', nextBest[u.name].rank);
            card.setAttribute('data-prob', nextBest[u.name].prob + '%');
        }
        card.innerHTML = `
            <div class="uplink-header">
                <span class="uplink-name">${u.name.toUpperCase()}</span>
                <div style="display:flex;align-items:center;gap:8px">
                    <span class="uplink-type">${typeClass}</span>
                    <div class="uplink-toggle ${u.enabled !== false ? 'enabled' : ''}" onclick="toggleUplink('${u.name}')" title="Toggle uplink"></div>
                </div>
            </div>
            <div class="metrics-grid">${metricsHtml}</div>
            <div class="sparkline">${sparkHtml}</div>
            <div class="uplink-actions">
                <button class="btn-fail" onclick="forceFail('${u.name}')">FORCE FAIL</button>
                <button class="btn-fail" style="border-color:var(--blue);color:var(--blue)" onclick="forceSwitch('${u.name}')">FORCE ACTIVE</button>
            </div>
        `;
        container.appendChild(card);
    });
}

function updateStatus(s) {
    // Mode badge
    const modeBadge = document.getElementById('mode-badge');
    modeBadge.textContent = s.mode || 'OFFLINE';
    modeBadge.className = 'badge mode-' + (s.mode || 'offline').toLowerCase();
    
    // State badge  
    const stateBadge = document.getElementById('state-badge');
    stateBadge.textContent = s.state || 'OFFLINE';
    stateBadge.className = 'badge state-' + (s.state || 'offline').toLowerCase();
    
    // Training banner
    document.getElementById('training-banner').classList.toggle('active', s.mode === 'TRAINING');
    
    // Speed
    document.getElementById('speed-val').textContent = Math.round(s.gps?.speed_mph || 0);
    
    // Node ID
    document.getElementById('node-id').textContent = s.node_id || '--';
    document.getElementById('run-id').textContent = s.run_id || '--';
    
    // Duplication
    document.getElementById('dup-status').textContent = s.dup_enabled ? 'ON' : 'OFF';
    document.getElementById('dup-status').style.color = s.dup_enabled ? 'var(--orange)' : 'var(--muted)';
    
    // Countdown panel
    const inProtection = ['PROTECT', 'SWITCHING', 'HOLDING'].includes(s.state);
    document.getElementById('countdown-panel').classList.toggle('active', inProtection);
    if (inProtection) {
        document.getElementById('trigger-reason').textContent = s.trigger || '--';
        document.getElementById('cd-hold').textContent = s.hold_remaining || 0;
        document.getElementById('cd-clean').textContent = s.clean_remaining || 0;
        document.getElementById('cd-switches').textContent = s.switches_this_window || 0;
    }
    
    // Flap banner
    document.getElementById('flap-banner').classList.toggle('active', s.flap_suppressed);
    
    // Risk
    const riskPct = Math.round((s.global_risk || 0) * 100);
    document.getElementById('risk-pct').textContent = riskPct + '%';
    document.getElementById('risk-pct').style.color = riskPct > 60 ? 'var(--red)' : riskPct > 30 ? 'var(--yellow)' : 'var(--green)';
    document.getElementById('risk-fill').style.width = riskPct + '%';
    
    const recEl = document.getElementById('risk-rec');
    recEl.textContent = s.recommendation || 'NORMAL';
    if (s.recommendation === 'PROTECT') {
        recEl.style.background = 'rgba(255,102,0,0.2)';
        recEl.style.color = 'var(--orange)';
    } else if (s.recommendation === 'PREPARE') {
        recEl.style.background = 'rgba(255,170,0,0.2)';
        recEl.style.color = 'var(--yellow)';
    } else {
        recEl.style.background = 'rgba(0,255,136,0.2)';
        recEl.style.color = 'var(--green)';
    }
    
    // GPS
    if (s.gps?.valid) {
        document.getElementById('gps-coords').textContent = 
            s.gps.lat.toFixed(6) + ', ' + s.gps.lon.toFixed(6);
        document.getElementById('gps-heading').textContent = Math.round(s.gps.heading || 0);
        document.getElementById('gps-alt').textContent = Math.round(s.gps.alt || 0);
        
        const latlng = [s.gps.lat, s.gps.lon];
        if (posMarker) {
            posMarker.setLatLng(latlng);
        } else {
            posMarker = L.circleMarker(latlng, {
                radius: 8, fillColor: '#00d4ff', fillOpacity: 1, 
                color: '#fff', weight: 2
            }).addTo(map);
            map.setView(latlng, 15);
        }
        
        // Trail
        trail.push(latlng);
        if (trail.length > 500) trail.shift();
        trailLine.setLatLngs(trail);
    }
    
    // Controller
    document.getElementById('ctrl-active').textContent = 
        s.active_controller === 0 ? 'Controller A' : 'Controller B';
    
    // Uplinks
    if (s.uplinks) {
        renderUplinks(s.uplinks);
    }
    
    // Mode buttons
    ['training', 'tripwire', 'mirror'].forEach(m => {
        document.getElementById('btn-' + m).classList.toggle('active', 
            s.mode?.toLowerCase() === m);
    });
}

function addFeedItem(type, msg, reason) {
    const feed = document.getElementById('feed');
    const now = new Date();
    const ts = now.toTimeString().split(' ')[0] + '.' + 
               String(now.getMilliseconds()).padStart(3, '0');
    
    const item = document.createElement('div');
    item.className = 'feed-item ' + type;
    item.innerHTML = `
        <div class="feed-time">${ts}</div>
        <div class="feed-msg">${msg}${reason ? ' <span class="feed-reason">[' + reason + ']</span>' : ''}</div>
    `;
    feed.insertBefore(item, feed.firstChild);
    if (feed.children.length > 100) feed.removeChild(feed.lastChild);
}

// API calls
async function setMode(mode) {
    await fetch('/api/control/mode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode})
    });
    addFeedItem('mode', 'Mode changed to ' + mode.toUpperCase());
}

async function forceSwitch(uplink) {
    _uplinkInteractionLock = Date.now() + 2000;
    await fetch('/api/control/force', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uplink})
    });
    addFeedItem('switch', 'Manual switch to ' + uplink.toUpperCase());
}

async function forceFail(uplink) {
    _uplinkInteractionLock = Date.now() + 2000;
    console.log("forceFail called:", uplink);
    await fetch('/api/control/fail', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uplink})
    });
    addFeedItem('tripwire', 'Force fail on ' + uplink.toUpperCase(), 'manual');
}

async function triggerProtection() {
    await fetch('/api/control/trigger', {method: 'POST'});
    addFeedItem('tripwire', 'Manual protection trigger', 'operator');
}

async function switchController(ctrl) {
    await fetch('/api/control/controller', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({controller: ctrl})
    });
    addFeedItem('switch', 'Controller switch to ' + (ctrl === 0 ? 'A' : 'B'));
}

// SSE connection
let lastState = '';
const evtSource = new EventSource('/api/stream');
evtSource.onmessage = (e) => {
    const status = JSON.parse(e.data);
    
    // Detect state changes for feed
    if (status.state !== lastState && lastState) {
        if (status.state === 'PROTECT') {
            addFeedItem('tripwire', 'Protection activated', status.trigger);
        } else if (status.state === 'NORMAL' && lastState !== 'NORMAL') {
            addFeedItem('predict', 'Returned to normal operation');
        }
    }
    lastState = status.state;
    
    checkStateChanges(status);
    updateStatus(status);
    updateStats(status);
};
evtSource.onerror = () => {
    console.log('SSE reconnecting...');
};

// Initial load
fetch('/api/status').then(r => r.json()).then(updateStatus).catch(() => {});

// Event Log
const eventLog = [];
let logFilter = "all";

function addLogEntry(level, msg, gps, persist=true) {
    const now = new Date();
    const ts = now.toTimeString().split(" ")[0] + "." + String(now.getMilliseconds()).padStart(3, "0");
    const entry = { time: ts, level, msg, gps: gps || null, timestamp: now };
    eventLog.push(entry);
    if (eventLog.length > 500) eventLog.shift();
    if (persist) { fetch("/api/events/log", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:level,message:msg,detail:gps||""})}).catch(()=>{}); }
    renderLog();
}

function renderLog() {
    const container = document.getElementById("event-log-content");
    const filtered = logFilter === "all" ? eventLog : eventLog.filter(e => e.level === logFilter);
    container.innerHTML = filtered.slice(-100).map(e => `
        <div class="log-entry">
            <span class="log-time">${e.time}</span>
            <span class="log-level ${e.level}">${e.level.toUpperCase()}</span>
            <span class="log-msg">${e.msg}</span>
            ${e.gps ? `<span class="log-gps">[${e.gps}]</span>` : ""}
        </div>
    `).join("");
    container.scrollTop = container.scrollHeight;
}

function filterLog(filter) {
    logFilter = filter;
    document.querySelectorAll(".event-log-controls button").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    renderLog();
}

function exportLog() {
    const csv = "Time,Level,Message,GPS\n" + eventLog.map(e =>
        `${e.time},${e.level},"${e.msg}",${e.gps||""}`
    ).join("\n");
    const blob = new Blob([csv], {type: "text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "pathsteer_log_" + new Date().toISOString().slice(0,19).replace(/:/g,"-") + ".csv";
    a.click();
}

// Log state changes
let prevState = null, prevMode = null, prevActive = null;
function checkStateChanges(s) {
    const gps = s.gps?.valid ? `${s.gps.lat.toFixed(5)},${s.gps.lon.toFixed(5)}` : null;
    if (prevState !== s.state && prevState !== null) {
        if (s.state === "PROTECT") addLogEntry("trigger", `TRIPWIRE fired: ${s.trigger}`, gps);
        else if (s.state === "SWITCHING") addLogEntry("warn", "Executing path switch", gps);
        else if (s.state === "HOLDING") addLogEntry("switch", `Switched to ${s.active_uplink}`, gps);
        else if (s.state === "NORMAL") addLogEntry("info", "Returned to NORMAL", gps);
    }
    if (prevMode !== s.mode && prevMode !== null) addLogEntry("info", `Mode changed to ${s.mode}`, gps);
    if (prevActive !== s.active_uplink && prevActive !== null) addLogEntry("switch", `Active uplink: ${prevActive} ‚Üí ${s.active_uplink}`, gps);
    // LLM failover savings tracking
    if (prevActive !== s.active_uplink && prevActive !== null) {
        fetch("/api/llm/status").then(r=>r.json()).then(d=>{
            if(d.running && d.total_tokens > 0) {
                let sessionValue = d.total_tokens * llmCostPerToken;
                llmSavedDollars += sessionValue;
                llmFailoverCount++;
                addLogEntry("switch", `üí∞ LLM failover saved $${sessionValue.toFixed(4)} (total saved: $${llmSavedDollars.toFixed(4)})`, gps);
            }
        }).catch(e=>{});
    }
    prevState = s.state; prevMode = s.mode; prevActive = s.active_uplink;
}

// Startup log
addLogEntry("info", "PathSteer Guardian UI connected", null, false);

// Update stats from status
function updateStats(s) {
    // Find best/worst RTT
    const available = (s.uplinks || []).filter(u => u.enabled && u.available);
    if (available.length > 0) {
        const sorted = [...available].sort((a,b) => (a.rtt_ms||999) - (b.rtt_ms||999));
        document.getElementById('stat-best-path').textContent = sorted[0].name.toUpperCase() + ' (' + (sorted[0].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-worst-path').textContent = sorted[sorted.length-1].name.toUpperCase() + ' (' + (sorted[sorted.length-1].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-diversity').textContent = available.length + '/' + (s.uplinks||[]).filter(u=>u.enabled).length;
        
        // Path Prediction update
        const activeUplink = (s.uplinks || []).find(u => u.active);
        const nonActive = available.filter(u => !u.active);
        const scored = nonActive.map(u => ({
            name: u.name,
            score: (u.rtt_ms || 999) + (u.risk_now || 0) * 100 + (u.loss_pct || 0) * 10
        })).sort((a, b) => a.score - b.score);
        
        const totalInv = scored.reduce((s, x) => s + 1000/(x.score+1), 0);
        const probs = scored.map(x => ({ name: x.name, prob: Math.round((1000/(x.score+1))/totalInv*100) }));
        
        document.getElementById('pred-active').textContent = activeUplink ? activeUplink.name.toUpperCase() : '--';
        document.getElementById('pred-next').textContent = probs[0] ? probs[0].name.toUpperCase() + ' (' + probs[0].prob + '%)' : '--';
        document.getElementById('pred-2nd').textContent = probs[1] ? probs[1].name.toUpperCase() + ' (' + probs[1].prob + '%)' : '--';
        document.getElementById('pred-3rd').textContent = probs[2] ? probs[2].name.toUpperCase() + ' (' + probs[2].prob + '%)' : '--';
    }
    
    // Throughput (placeholder - would come from actual traffic stats)
    const downMbps = s.throughput_down_mbps || 0;
    const upMbps = s.throughput_up_mbps || 0;
    document.getElementById('throughput-down').textContent = downMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-up').textContent = upMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-down-bar').style.width = Math.min(100, downMbps) + '%';
    document.getElementById('throughput-up-bar').style.width = Math.min(100, upMbps * 2) + '%';
    
    // Session uptime
    if (s.run_id) {
        const parts = s.run_id.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
        const start = parts ? new Date(parts[1], parts[2]-1, parts[3], parts[4], parts[5], parts[6]) : new Date();
        const now = new Date();
        const mins = Math.floor((now - start) / 60000);
        const hrs = Math.floor(mins / 60);
        document.getElementById('stat-uptime').textContent = hrs + 'h ' + (mins % 60) + 'm';
    }
}

// Toggle uplink enabled
async function toggleUplink(name) {
    _uplinkInteractionLock = Date.now() + 2000;
    const resp = await fetch('/api/uplink/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name})
    });
    const data = await resp.json();
    console.log('Toggled', name, data);
    
    // Immediately update the toggle UI
    const card = document.querySelector(`.uplink-card[data-name="${name}"]`);
    if (card) {
        const toggle = card.querySelector('.uplink-toggle');
        if (toggle) {
            toggle.classList.toggle('enabled', data.enabled);
        }
        // Also dim/undim the card
        card.style.opacity = data.enabled ? '1' : '0.5';
    }
}

/* Load event history from database */
async function loadEventHistory() {
    try {
        const resp = await fetch("/api/events/history?limit=50");
        const events = await resp.json();
        events.reverse().forEach(e => {
            const ts = e.timestamp ? e.timestamp.split(" ")[1] || e.timestamp.substring(11,19) : "";
            /* Add to Event Log (bottom) */
            eventLog.push({time: ts, level: e.type, msg: e.message, gps: e.detail || null, timestamp: new Date(e.timestamp)});
        });
        renderLog();
    } catch(err) { console.log("Could not load event history:", err); }
}

/* Load event history on page load */
loadEventHistory();
// LLM Floating Window
var llmCostPerToken = 0.002; // $/token - adjustable
var llmSavedDollars = 0;
var llmFailoverCount = 0;
function llmFloat() {
    if(document.getElementById("llm-float")) { document.getElementById("llm-float").remove(); return; }
    let w = document.createElement("div");
    w.id = "llm-float";
    w.style.cssText = "position:fixed;bottom:20px;right:20px;width:650px;height:70vh;background:var(--panel);border:2px solid var(--blue);border-radius:8px;z-index:9998;display:flex;flex-direction:column;box-shadow:0 0 30px rgba(0,212,255,0.2);resize:both;overflow:hidden";
    w.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:linear-gradient(90deg,var(--card),var(--panel));cursor:move" onmousedown="llmDrag(event)">
        <span style="color:var(--blue);font-size:12px;font-weight:bold">‚ö° PathSteer LLM Lab</span>
        <div><span id="llm-fl-status" style="font-size:10px;color:var(--muted);margin-right:8px">Stopped</span><button onclick="document.getElementById(\x27llm-float\x27).remove()" style="background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;font-family:inherit">‚úï</button></div>
    </div>
    <div style="padding:8px 12px;flex-shrink:0">
        <textarea id="llm-fl-prompt" rows="2" style="width:100%;background:var(--bg);color:var(--text);border:1px solid var(--border);padding:8px;font-size:12px;font-family:inherit;border-radius:4px;resize:vertical">${document.getElementById("llm-prompt").value}</textarea>
        <div style="display:flex;gap:6px;margin-top:6px">
            <select id="llm-fl-loops" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-size:11px;font-family:inherit;padding:5px;border-radius:4px">
                <option value="0">Continuous</option><option value="1">1 shot</option><option value="5">5 loops</option><option value="10">10</option><option value="50">50</option><option value="100">100</option>
            </select>
            <button onclick="llmFlStart()" style="flex:1;background:var(--green);color:var(--bg);border:none;padding:6px;font-size:11px;font-family:inherit;cursor:pointer;border-radius:4px;font-weight:bold">‚ñ∂ START</button>
            <button onclick="llmStop();document.getElementById(\x27llm-fl-status\x27).textContent=\x27Stopped\x27" style="background:var(--red);color:white;border:none;padding:6px 12px;font-size:11px;font-family:inherit;cursor:pointer;border-radius:4px;font-weight:bold">‚ñ†</button>
        </div>
        <div style="display:flex;gap:10px;margin-top:8px;font-size:10px;flex-wrap:wrap">
            <div>‚ö° <span id="llm-fl-tps" style="color:var(--blue);font-weight:bold">0</span> tok/s</div>
            <div>üìä <span id="llm-fl-total" style="color:var(--green);font-weight:bold">0</span> tokens</div>
            <div>üîÑ <span id="llm-fl-reqs" style="color:var(--text)">0</span> reqs</div>
            <div>‚ùå <span id="llm-fl-errs" style="color:var(--red)">0</span></div>
            <div>üí∞ $<span id="llm-fl-cost" style="color:var(--yellow);font-weight:bold">0.00</span> value</div>
            <div>üõ°Ô∏è $<span id="llm-fl-saved" style="color:var(--green);font-weight:bold">0.00</span> saved by failover</div>
        </div>
        <div style="margin-top:4px;font-size:9px;color:var(--muted)">Cost/token: $<input id="llm-fl-cpt" type="number" step="0.001" value="0.002" style="width:60px;background:var(--bg);color:var(--yellow);border:1px solid var(--border);font-size:9px;font-family:inherit;padding:2px;border-radius:2px" onchange="llmCostPerToken=parseFloat(this.value)"></div>
    </div>
    <div style="flex:1;overflow-y:auto;margin:0 12px 12px;min-height:0;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;font-size:12px;line-height:1.7;color:var(--text)" id="llm-fl-output">Waiting for output...</div>`;
    document.body.appendChild(w);
    llmFlPoll();
}
var llmDragEl=null,llmDragX=0,llmDragY=0;
function llmDrag(e){llmDragEl=document.getElementById("llm-float");llmDragX=e.clientX-llmDragEl.offsetLeft;llmDragY=e.clientY-llmDragEl.offsetTop;document.onmousemove=function(e){llmDragEl.style.left=(e.clientX-llmDragX)+"px";llmDragEl.style.top=(e.clientY-llmDragY)+"px";llmDragEl.style.right="auto";llmDragEl.style.bottom="auto"};document.onmouseup=function(){document.onmousemove=null}}
async function llmFlStart() {
    const prompt = document.getElementById("llm-fl-prompt").value;
    const loops = parseInt(document.getElementById("llm-fl-loops").value);
    document.getElementById("llm-prompt").value = prompt;
    await fetch("/api/llm/start", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({prompt:prompt, loop_count:loops})});
}
function llmFlPoll() {
    if(!document.getElementById("llm-float")) return;
    fetch("/api/llm/status").then(r=>r.json()).then(d=>{
        let el;
        el=document.getElementById("llm-fl-tps"); if(el) el.textContent=d.tokens_per_sec||0;
        el=document.getElementById("llm-fl-total"); if(el) el.textContent=d.total_tokens||0;
        el=document.getElementById("llm-fl-reqs"); if(el) el.textContent=d.total_requests||0;
        el=document.getElementById("llm-fl-errs"); if(el) el.textContent=d.errors||0;
        el=document.getElementById("llm-fl-output"); if(el && d.full_log) { el.textContent=d.full_log; el.scrollTop=el.scrollHeight; }
        el=document.getElementById("llm-fl-status"); if(el) { el.textContent=d.running?"‚ö° Running":"Stopped"; el.style.color=d.running?"var(--green)":"var(--muted)"; }
        let cost=(d.total_tokens||0)*llmCostPerToken;
        el=document.getElementById("llm-fl-cost"); if(el) el.textContent=cost.toFixed(4);
        el=document.getElementById("llm-fl-saved"); if(el) el.textContent=llmSavedDollars.toFixed(4);
    }).catch(e=>{});
    setTimeout(llmFlPoll, 500);
}
// LLM Popup Modal
function llmPopup() {
    let d = document.createElement("div");
    d.id = "llm-modal";
    d.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center";
    d.innerHTML = `<div style="background:var(--panel);border:1px solid var(--blue);border-radius:8px;width:600px;max-height:80vh;padding:16px;font-family:inherit">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="color:var(--blue);font-size:14px">‚ö° PathSteer LLM Lab</h3>
            <button onclick="document.getElementById(\x27llm-modal\x27).remove()" style="background:none;border:none;color:var(--red);font-size:18px;cursor:pointer;font-family:inherit">‚úï</button>
        </div>
        <div style="margin-bottom:10px">
            <label style="color:var(--muted);font-size:10px">PROMPT</label>
            <textarea id="llm-pop-prompt" rows="3" style="width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px;font-size:11px;font-family:inherit;border-radius:4px;resize:vertical">${document.getElementById("llm-prompt").value}</textarea>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px">
            <select id="llm-pop-loops" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-size:11px;font-family:inherit;padding:6px;border-radius:4px">
                <option value="0">Continuous</option><option value="1">1 shot</option><option value="5">5 loops</option><option value="10">10 loops</option><option value="50">50 loops</option>
            </select>
            <button onclick="llmPopStart()" style="flex:1;background:var(--green);color:var(--bg);border:none;padding:8px;font-size:12px;font-family:inherit;cursor:pointer;border-radius:4px;font-weight:bold">‚ñ∂ START</button>
            <button onclick="llmStop()" style="flex:1;background:var(--red);color:white;border:none;padding:8px;font-size:12px;font-family:inherit;cursor:pointer;border-radius:4px;font-weight:bold">‚ñ† STOP</button>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:10px;font-size:11px">
            <div>Tokens/s: <span id="llm-pop-tps" style="color:var(--blue);font-weight:bold">0</span></div>
            <div>Total: <span id="llm-pop-total" style="color:var(--green);font-weight:bold">0</span></div>
            <div>Requests: <span id="llm-pop-reqs" style="color:var(--text)">0</span></div>
            <div>Errors: <span id="llm-pop-errs" style="color:var(--red)">0</span></div>
            <div id="llm-pop-status" style="color:var(--muted)">Stopped</div>
        </div>
        <div style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;max-height:300px;overflow-y:auto;font-size:11px;line-height:1.6;color:var(--text)" id="llm-pop-output">Waiting for output...</div>
    </div>`;
    d.addEventListener("click", function(e) { if(e.target === d) d.remove(); });
    document.body.appendChild(d);
    llmPopPoll();
}
async function llmPopStart() {
    const prompt = document.getElementById("llm-pop-prompt").value;
    const loops = parseInt(document.getElementById("llm-pop-loops").value);
    document.getElementById("llm-prompt").value = prompt;
    await fetch("/api/llm/start", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({prompt:prompt, loop_count:loops})});
}
function llmPopPoll() {
    if(!document.getElementById("llm-modal")) return;
    fetch("/api/llm/status").then(r=>r.json()).then(d=>{
        let el = document.getElementById("llm-pop-tps"); if(el) el.textContent = d.tokens_per_sec||0;
        el = document.getElementById("llm-pop-total"); if(el) el.textContent = d.total_tokens||0;
        el = document.getElementById("llm-pop-reqs"); if(el) el.textContent = d.total_requests||0;
        el = document.getElementById("llm-pop-errs"); if(el) el.textContent = d.errors||0;
        el = document.getElementById("llm-pop-output"); if(el && d.last_response) el.textContent = d.last_response;
        el = document.getElementById("llm-pop-status"); if(el) { el.textContent = d.running?"‚ö° Running":"Stopped"; el.style.color = d.running?"var(--green)":"var(--muted)"; }
    }).catch(e=>{});
    setTimeout(llmPopPoll, 500);
}
// LLM Test Functions
async function llmStart() {
    const prompt = document.getElementById("llm-prompt").value;
    const loops = parseInt(document.getElementById("llm-loops").value);
    await fetch("/api/llm/start", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({prompt:prompt, loop_count:loops})});
    document.getElementById("target-llm").textContent = "Running";
    document.getElementById("target-llm").style.color = "var(--green)";
}
async function llmStop() {
    await fetch("/api/llm/stop", {method:"POST"});
    document.getElementById("target-llm").textContent = "Stopped";
    document.getElementById("target-llm").style.color = "var(--muted)";
}
async function llmPoll() {
    try {
        const r = await fetch("/api/llm/status");
        const d = await r.json();
        document.getElementById("llm-tps").textContent = d.tokens_per_sec || 0;
        document.getElementById("llm-total").textContent = d.total_tokens || 0;
        document.getElementById("llm-reqs").textContent = d.total_requests || 0;
        document.getElementById("llm-errs").textContent = d.errors || 0;
        if(d.last_response) document.getElementById("llm-response").textContent = d.last_response;
        if(d.running) { document.getElementById("target-llm").textContent = "Running"; document.getElementById("target-llm").style.color = "var(--green)"; }
        else { document.getElementById("target-llm").textContent = "Stopped"; document.getElementById("target-llm").style.color = "var(--muted)"; }
    } catch(e) {}
}
setInterval(llmPoll, 1000);
</script>
</body>
</html>
