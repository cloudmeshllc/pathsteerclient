<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathSteer Guardian</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #0a0a0f;
            --panel: #12121a;
            --card: #1a1a2e;
            --border: #2a2a4e;
            --text: #e0e0e0;
            --muted: #666;
            --blue: #00d4ff;
            --purple: #7b2cbf;
            --green: #00ff88;
            --yellow: #ffaa00;
            --orange: #ff6600;
            --red: #ff4444;
            --sl-blue: #1DA1F2;
            --tmo-magenta: #E20074;
            --att-blue: #00A8E0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Mono', 'Fira Code', monospace; 
            background: var(--bg); 
            color: var(--text); 
            font-size: 11px;
            overflow: hidden;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 260px 1fr 280px 260px;
            grid-template-rows: 48px 1fr 160px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, var(--panel), #1a1a30);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 14px; font-weight: 700; letter-spacing: 2px; }
        .logo .g { color: var(--blue); }
        
        .badges { display: flex; gap: 10px; align-items: center; }
        .badge {
            padding: 5px 12px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .mode-training { background: rgba(0,212,255,0.15); color: var(--blue); border: 1px solid var(--blue); }
        .mode-tripwire { background: rgba(255,170,0,0.15); color: var(--yellow); border: 1px solid var(--yellow); }
        .mode-mirror { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid var(--green); }
        .state-normal { background: rgba(0,255,136,0.1); color: var(--green); }
        .state-prepare { background: rgba(255,170,0,0.1); color: var(--yellow); animation: pulse 1.5s infinite; }
        .state-protect { background: rgba(255,102,0,0.15); color: var(--orange); animation: pulse 0.8s infinite; }
        .state-switching { background: rgba(255,68,68,0.15); color: var(--red); animation: pulse 0.5s infinite; }
        .state-holding { background: rgba(123,44,191,0.15); color: var(--purple); }
        .state-offline { background: rgba(100,100,100,0.2); color: #666; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .speed-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--blue);
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        .speed-display .unit { font-size: 11px; color: var(--muted); }
        
        /* Panels */
        .panel { background: var(--panel); padding: 10px; overflow-y: auto; }
        .panel h2 {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--muted);
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Training Banner */
        .training-banner {
            background: repeating-linear-gradient(45deg, var(--card), var(--card) 10px, var(--bg) 10px, var(--bg) 20px);
            border: 2px solid var(--blue);
            padding: 8px;
            text-align: center;
            font-weight: 700;
            color: var(--blue);
            margin-bottom: 10px;
            display: none;
        }
        .training-banner.active { display: block; }
        
        /* Uplink Cards */
        .uplink-card {
            background: var(--card);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            border: 2px solid var(--border);
            position: relative;
            transition: all 0.2s;
        }
        .uplink-card.active { border-color: var(--green); box-shadow: 0 0 12px rgba(0,255,136,0.2); }
        .uplink-card.active::after {
            content: '‚óè ACTIVE';
            position: absolute;
            top: 6px;
            right: 8px;
            font-size: 8px;
            color: var(--green);
            animation: blink 1s infinite;
        }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .uplink-card.unavailable { opacity: 0.4; }
        .uplink-card.lte { border-left: 3px solid var(--tmo-magenta); }
        .uplink-card.lte.att { border-left-color: var(--att-blue); }
        .uplink-card.starlink { border-left: 3px solid var(--sl-blue); }
        .uplink-card.fiber { border-left: 3px solid var(--green); }
        
        .uplink-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .uplink-name { font-weight: 700; font-size: 11px; }
        .uplink-type { font-size: 9px; color: var(--muted); }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .metric {
            background: var(--bg);
            padding: 4px;
            border-radius: 2px;
            text-align: center;
        }
        .metric-label { font-size: 8px; color: var(--muted); text-transform: uppercase; }
        .metric-value { font-size: 11px; font-weight: 600; color: var(--blue); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.bad { color: var(--red); }
        
        .sparkline {
            height: 16px;
            background: var(--bg);
            border-radius: 2px;
            margin-top: 4px;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }
        .spark-bar {
            flex: 1;
            background: var(--blue);
            margin: 0 1px;
            min-height: 1px;
            transition: height 0.1s;
        }
        .spark-bar.warn { background: var(--yellow); }
        .spark-bar.bad { background: var(--red); }
        
        .uplink-actions { margin-top: 6px; display: flex; gap: 4px; }
        .btn-fail {
            flex: 1;
            padding: 4px;
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            font-size: 8px;
            border-radius: 2px;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn-fail:hover { background: var(--red); color: var(--bg); }
        
        /* GPS Panel */
        .gps-panel {
            background: var(--card);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .gps-coords { font-family: monospace; color: var(--blue); font-size: 12px; }
        .gps-meta { font-size: 9px; color: var(--muted); margin-top: 4px; }
        
        /* Risk Gauge */
        .risk-panel {
            background: var(--card);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .risk-header { display: flex; justify-content: space-between; align-items: center; }
        .risk-value { font-size: 20px; font-weight: 700; }
        .risk-rec { font-size: 10px; padding: 3px 8px; border-radius: 2px; }
        .risk-bar { height: 6px; background: var(--bg); border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .risk-fill { height: 100%; background: linear-gradient(90deg, var(--green), var(--yellow), var(--red)); transition: width 0.3s; }
        
        /* Map */
        .map-panel { position: relative; }
        #map { height: 100%; background: var(--bg); }
        .map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(18,18,26,0.95);
            padding: 8px;
            border-radius: 4px;
            font-size: 9px;
            z-index: 1000;
        }
        .legend-row { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        
        /* Right Panel */
        .countdown-panel {
            background: linear-gradient(135deg, rgba(255,102,0,0.1), rgba(255,170,0,0.05));
            border: 1px solid var(--orange);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: center;
            display: none;
        }
        .countdown-panel.active { display: block; }
        .countdown-title { font-weight: 700; font-size: 11px; }
        .countdown-trigger { font-size: 9px; color: var(--yellow); margin-top: 4px; }
        .countdown-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
        .countdown-item { text-align: center; }
        .countdown-num { font-size: 22px; font-weight: 700; color: var(--orange); }
        .countdown-label { font-size: 8px; color: var(--muted); text-transform: uppercase; }
        
        .flap-banner {
            background: rgba(123,44,191,0.2);
            border: 1px solid var(--purple);
            padding: 6px;
            border-radius: 4px;
            text-align: center;
            font-size: 9px;
            color: var(--purple);
            margin-bottom: 8px;
            display: none;
        }
        .flap-banner.active { display: block; }
        
        /* Controls */
        .control-group { margin-bottom: 10px; }
        .btn-row { display: flex; gap: 4px; }
        .btn {
            flex: 1;
            padding: 8px 4px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 9px;
            font-weight: 600;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn:hover { background: var(--border); }
        .btn.active { background: var(--blue); color: var(--bg); border-color: var(--blue); }
        .btn.danger { border-color: var(--red); color: var(--red); }
        .btn.danger:hover { background: var(--red); color: var(--bg); }
        .btn-wide { width: 100%; }
        
        /* Decision Feed */
        .feed { max-height: 200px; overflow-y: auto; }
        .feed-item {
            background: var(--card);
            padding: 6px;
            margin-bottom: 3px;
            border-radius: 3px;
            font-size: 9px;
            border-left: 2px solid var(--border);
        }
        .feed-item.tripwire { border-left-color: var(--orange); background: rgba(255,102,0,0.05); }
        .feed-item.switch { border-left-color: var(--purple); }
        .feed-item.predict { border-left-color: var(--blue); }
        .feed-item.mode { border-left-color: var(--green); }
        .feed-time { color: var(--muted); font-size: 8px; }
        .feed-msg { margin-top: 2px; }
        .feed-reason { color: var(--yellow); }
        
        /* Controller Panel */
        .controller-panel {
            background: var(--card);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; margin: 4px 0; }
        .ctrl-label { font-size: 9px; color: var(--muted); }
        .ctrl-value { font-size: 10px; color: var(--blue); }
        .ctrl-value.active { color: var(--green); }
        
        /* Remote Targets */
        .targets-panel { font-size: 9px; color: var(--muted); }
        .target-row { display: flex; justify-content: space-between; margin: 2px 0; }
        .target-status { color: var(--green); }
        .target-status.offline { color: var(--red); }

        /* Event Log Panel */
        .event-log {
            grid-column: 1 / -1;
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .event-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
        }
        .event-log-header h3 {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
        }
        .event-log-controls {
            display: flex;
            gap: 8px;
        }
        .event-log-controls button {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 2px 8px;
            font-size: 9px;
            cursor: pointer;
            border-radius: 2px;
        }
        .event-log-controls button:hover { border-color: var(--blue); color: var(--blue); }
        .event-log-controls button.active { border-color: var(--blue); color: var(--blue); background: rgba(0,212,255,0.1); }
        .event-log-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
            font-family: monospace;
            font-size: 10px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(42,42,78,0.3);
            display: flex;
            gap: 12px;
        }
        .log-time { color: var(--muted); min-width: 90px; }
        .log-level { min-width: 60px; font-weight: 600; }
        .log-level.info { color: var(--blue); }
        .log-level.warn { color: var(--yellow); }
        .log-level.error { color: var(--red); }
        .log-level.switch { color: var(--green); }
        .log-level.trigger { color: var(--orange); }
        .log-msg { color: var(--text); flex: 1; }
        .log-gps { color: var(--muted); font-size: 9px; }

        /* Signal Bars */
        .signal-bars {
            display: inline-flex;
            align-items: flex-end;
            gap: 1px;
            height: 12px;
            margin-left: 4px;
            vertical-align: middle;
        }
        .signal-bar {
            width: 3px;
            background: var(--muted);
            border-radius: 1px;
        }
        .signal-bar.active { background: var(--green); }
        .signal-bar.warn { background: var(--yellow); }
        .signal-bar.bad { background: var(--red); }
        .signal-bar:nth-child(1) { height: 3px; }
        .signal-bar:nth-child(2) { height: 5px; }
        .signal-bar:nth-child(3) { height: 8px; }
        .signal-bar:nth-child(4) { height: 11px; }
        
        /* Obstruction Indicator */
        .obstr-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
        }
        .obstr-indicator.clear { background: var(--green); box-shadow: 0 0 4px var(--green); }
        .obstr-indicator.obstructed { background: var(--red); box-shadow: 0 0 4px var(--red); animation: pulse 0.5s infinite; }

        /* Signal Bars */
        .signal-bars {
            display: inline-flex;
            align-items: flex-end;
            gap: 1px;
            height: 12px;
            margin-left: 4px;
            vertical-align: middle;
        }
        .signal-bar {
            width: 3px;
            background: var(--muted);
            border-radius: 1px;
        }
        .signal-bar.active { background: var(--green); }
        .signal-bar.warn { background: var(--yellow); }
        .signal-bar.bad { background: var(--red); }
        .signal-bar:nth-child(1) { height: 3px; }
        .signal-bar:nth-child(2) { height: 5px; }
        .signal-bar:nth-child(3) { height: 8px; }
        .signal-bar:nth-child(4) { height: 11px; }
        
        /* Obstruction Indicator */
        .obstr-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
        }
        .obstr-indicator.clear { background: var(--green); box-shadow: 0 0 4px var(--green); }
        .obstr-indicator.obstructed { background: var(--red); box-shadow: 0 0 4px var(--red); animation: pulse 0.5s infinite; }

        /* Stats Panel */
        .stats-panel {
            background: var(--panel);
            padding: 10px;
            overflow-y: auto;
        }
        .stat-card {
            background: var(--card);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .stat-card h3 {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--muted); font-size: 10px; }
        .stat-value { color: var(--blue); font-size: 11px; font-weight: 600; }
        .stat-value.good { color: var(--green); }
        .stat-value.warn { color: var(--yellow); }
        .stat-value.bad { color: var(--red); }
        
        .big-stat {
            text-align: center;
            padding: 12px;
        }
        .big-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--blue);
        }
        .big-stat-label {
            font-size: 9px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .throughput-bar {
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }
        .throughput-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--green));
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 240px 1fr 240px;
                grid-template-rows: 48px 1fr 140px;
            }
            .stats-panel { display: none; }
        }
        
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 48px auto auto auto 120px;
            }
            .header { 
                grid-column: 1; 
                flex-wrap: wrap;
                padding: 8px;
                height: auto;
            }
            .panel.left-panel {
                grid-column: 1;
                grid-row: auto;
                max-height: 300px;
            }
            .panel.map-panel {
                grid-column: 1;
                grid-row: auto;
                min-height: 250px;
            }
            .stats-panel {
                display: none;
            }
            .panel:last-of-type {
                grid-column: 1;
                grid-row: auto;
                max-height: 250px;
            }
            .event-log {
                grid-column: 1;
                height: 120px;
            }
            .uplink-card {
                padding: 6px;
                margin-bottom: 4px;
            }
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 2px;
            }
            .metric {
                padding: 2px;
            }
            .metric-label { font-size: 7px; }
            .metric-value { font-size: 9px; }
            .sparkline { display: none; }
            .uplink-actions { display: none; }
            .btn { padding: 6px 10px; font-size: 9px; }
            .speed-display { font-size: 18px; }
            .logo h1 { font-size: 12px; }
        }
        
        @media (max-width: 600px) {
            .dashboard {
                grid-template-rows: 40px auto auto auto 100px;
            }
            .header {
                justify-content: center;
            }
            .badges { 
                gap: 4px;
            }
            .badge {
                padding: 3px 6px;
                font-size: 8px;
            }
            #node-id { display: none; }
            .panel.left-panel {
                max-height: 250px;
            }
            .panel.map-panel {
                min-height: 200px;
            }
            .uplink-card {
                padding: 4px;
            }
            .uplink-header {
                margin-bottom: 3px;
            }
            .uplink-name { font-size: 10px; }
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .gps-panel, .risk-panel { display: none; }
            .map-legend { display: none; }
            .event-log-controls button {
                padding: 2px 4px;
                font-size: 8px;
            }
            .log-entry {
                font-size: 9px;
                gap: 6px;
            }
            .log-time { min-width: 70px; }
            .log-level { min-width: 50px; }
        }

        /* Uplink Enable Toggle */
        .uplink-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 16px;
            background: var(--red);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .uplink-toggle.enabled { background: var(--green); }
        .uplink-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s;
        }
        .uplink-toggle.enabled::after { left: 18px; }
        .uplink-card { position: relative; }
        .uplink-card.disabled { opacity: 0.4; }

        /* Chaos Panel */
        .chaos-panel {
            background: var(--card);
            border: 1px solid var(--red);
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .chaos-panel h3 {
            color: var(--red);
            font-size: 10px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .chaos-slider {
            width: 100%;
            margin: 4px 0;
        }
        .chaos-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            font-size: 10px;
        }
        .chaos-value {
            color: var(--orange);
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }
        .chaos-btn {
            background: var(--red);
            border: none;
            color: white;
            padding: 6px 12px;
            font-size: 9px;
            cursor: pointer;
            border-radius: 3px;
            width: 100%;
            margin-top: 8px;
        }
        .chaos-btn:hover { background: #ff4444; }
        .chaos-btn.active { animation: pulse 0.5s infinite; }
    </style>
</head>
<body>
<div class="dashboard">
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <h1>PATHSTEER <span class="g">GUARDIAN</span></h1>
        </div>
        <div class="speed-display">
            <span id="speed-val">0</span>
            <span class="unit">mph</span>
        </div>
        <div class="badges">
            <span class="badge mode-tripwire" id="mode-badge">TRIPWIRE</span>
            <span class="badge state-normal" id="state-badge">NORMAL</span>
            <span style="font-size:9px;color:var(--muted)" id="node-id">--</span>
        <button onclick="window.open('/demo', 'chaos', 'width=1200,height=800,scrollbars=yes')" style="background:linear-gradient(135deg,#ff6b35,#f39c12);border:none;padding:8px 15px;border-radius:6px;cursor:pointer;font-weight:bold;color:#000;margin-left:10px;">üéõÔ∏è CHAOS</button>
        </div>
    </header>
    
    <!-- Left: Uplinks -->
    <div class="panel">
        <div class="training-banner" id="training-banner">‚ö† TRAINING MODE ‚Äî NO ACTUATION</div>
        
        <h2>Uplinks</h2>
        <div id="uplinks"></div>
        
        <h2>GPS</h2>
        <div class="gps-panel">
            <div class="gps-coords" id="gps-coords">--.------, --.------</div>
            <div class="gps-meta">
                Heading: <span id="gps-heading">--</span>¬∞ | Alt: <span id="gps-alt">--</span>m
            </div>
        </div>
        
        <h2>Global Risk</h2>
        <div class="risk-panel">
            <div class="risk-header">
                <span class="risk-value" id="risk-pct">0%</span>
                <span class="risk-rec" id="risk-rec" style="background:rgba(0,255,136,0.2);color:var(--green)">NORMAL</span>
            </div>
            <div class="risk-bar"><div class="risk-fill" id="risk-fill" style="width:0%"></div></div>
        </div>
    </div>
    
    <!-- Center: Map -->
    <div class="panel map-panel">
        <div id="map"></div>
        <div class="map-legend">
            <div style="font-weight:600;margin-bottom:4px">Signal Map</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--sl-blue)"></div> Starlink</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--tmo-magenta)"></div> T-Mobile</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--att-blue)"></div> AT&T</div>
            <div class="legend-row"><div class="legend-dot" style="background:var(--red)"></div> High Risk Zone</div>
        </div>
    </div>
    

    <!-- Stats Panel -->
    <div class="stats-panel">
        <div class="stat-card">
            <h3>Session Stats</h3>
            <div class="big-stat">
                <div class="big-stat-value" id="active-sessions">0</div>
                <div class="big-stat-label">Active Sessions</div>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Throughput</h3>
            <div class="stat-row">
                <span class="stat-label">Download</span>
                <span class="stat-value" id="throughput-down">0 Mbps</span>
            </div>
            <div class="throughput-bar"><div class="throughput-fill" id="throughput-down-bar" style="width:0%"></div></div>
            <div class="stat-row" style="margin-top:8px">
                <span class="stat-label">Upload</span>
                <span class="stat-value" id="throughput-up">0 Mbps</span>
            </div>
            <div class="throughput-bar"><div class="throughput-fill" id="throughput-up-bar" style="width:0%"></div></div>
        </div>
        
        <div class="stat-card">
            <h3>Protection Events</h3>
            <div class="stat-row">
                <span class="stat-label">Tripwires (24h)</span>
                <span class="stat-value" id="stat-tripwires">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Switches (24h)</span>
                <span class="stat-value" id="stat-switches">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg Switch Time</span>
                <span class="stat-value good" id="stat-switch-time">--</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Path Quality</h3>
            <div class="stat-row">
                <span class="stat-label">Best Path</span>
                <span class="stat-value good" id="stat-best-path">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Worst Path</span>
                <span class="stat-value warn" id="stat-worst-path">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Path Diversity</span>
                <span class="stat-value" id="stat-diversity">6/6</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Uptime</h3>
            <div class="stat-row">
                <span class="stat-label">Session</span>
                <span class="stat-value" id="stat-uptime">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Availability</span>
                <span class="stat-value good" id="stat-availability">100%</span>
            </div>
        </div>
    </div>

    <!-- Right: Controls & Status -->
    <div class="panel">
        <div class="flap-banner" id="flap-banner">‚ö° FLAP SUPPRESSED ‚Äî Max switches reached</div>
        
        <div class="countdown-panel" id="countdown-panel">
            <div class="countdown-title">PROTECTION ACTIVE</div>
            <div class="countdown-trigger">Trigger: <span id="trigger-reason">--</span></div>
            <div class="countdown-grid">
                <div class="countdown-item">
                    <div class="countdown-num" id="cd-hold">8</div>
                    <div class="countdown-label">Hold</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-num" id="cd-clean">5</div>
                    <div class="countdown-label">Clean</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-num" id="cd-switches">0</div>
                    <div class="countdown-label">Switches</div>
                </div>
            </div>
        </div>
        
        <h2>Mode</h2>
        <div class="control-group">
            <div class="btn-row">
                <button class="btn" id="btn-training" onclick="setMode('training')">TRAINING</button>
                <button class="btn active" id="btn-tripwire" onclick="setMode('tripwire')">TRIPWIRE</button>
                <button class="btn" id="btn-mirror" onclick="setMode('mirror')">MIRROR</button>
            </div>
        </div>
        
        <h2>Manual Trigger</h2>
        <div class="control-group">
            <button class="btn btn-wide danger" onclick="triggerProtection()">‚ö° TRIGGER PROTECTION NOW</button>
        </div>
        
        <h2>Controller</h2>
        <div class="controller-panel">
            <div class="ctrl-row">
                <span class="ctrl-label">Active:</span>
                <span class="ctrl-value active" id="ctrl-active">Controller A</span>
            </div>
            <div class="ctrl-row">
                <span class="ctrl-label">C8000:</span>
                <span class="ctrl-value" id="ctrl-c8000">pop-dal.pathsteernetworks.com</span>
            </div>
            <div class="btn-row" style="margin-top:6px">
                <button class="btn" onclick="switchController(0)">CTRL-A</button>
                <button class="btn" onclick="switchController(1)">CTRL-B</button>
            </div>
        </div>
        
        <h2>Decision Feed</h2>
        <div class="feed" id="feed">
            <div class="feed-item predict">
                <div class="feed-time">--:--:--.---</div>
                <div class="feed-msg">Waiting for events...</div>
            </div>
        </div>
        
        <h2 style="margin-top:10px">Remote Targets</h2>
        <div class="targets-panel">
            <div class="target-row">
                <span>Voice (SIP):</span>
                <span class="target-status" id="target-voice">--</span>
            </div>
            <div class="target-row">
                <span>LLM:</span>
                <span class="target-status offline" id="target-llm">Not configured</span>
            </div>
        </div>
        
        <h2 style="margin-top:10px">Run</h2>
        <div style="font-size:9px">
            <div style="color:var(--muted)">ID: <span style="color:var(--blue)" id="run-id">--</span></div>
            <div style="color:var(--muted)">Dup: <span id="dup-status" style="color:var(--muted)">OFF</span></div>
        </div>
    </div>

    <!-- Event Log Panel -->
    <div class="event-log">
        <div class="event-log-header">
            <h3>Event Log</h3>
            <div class="event-log-controls">
                <button class="active" onclick="filterLog('all')">ALL</button>
                <button onclick="filterLog('trigger')">TRIGGERS</button>
                <button onclick="filterLog('switch')">SWITCHES</button>
                <button onclick="filterLog('error')">ERRORS</button>
                <button onclick="exportLog()" style="border-color:var(--green);color:var(--green)">EXPORT</button>
            </div>
        </div>
        <div class="event-log-content" id="event-log-content">
            <div class="log-entry">
                <span class="log-time">--:--:--.---</span>
                <span class="log-level info">INFO</span>
                <span class="log-msg">Waiting for events...</span>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
// Update stats from status
function updateStats(s) {
    // Find best/worst RTT
    const available = (s.uplinks || []).filter(u => u.enabled && u.available);
    if (available.length > 0) {
        const sorted = [...available].sort((a,b) => (a.rtt_ms||999) - (b.rtt_ms||999));
        document.getElementById('stat-best-path').textContent = sorted[0].name.toUpperCase() + ' (' + (sorted[0].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-worst-path').textContent = sorted[sorted.length-1].name.toUpperCase() + ' (' + (sorted[sorted.length-1].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-diversity').textContent = available.length + '/' + (s.uplinks||[]).filter(u=>u.enabled).length;
    }
    
    // Throughput (placeholder - would come from actual traffic stats)
    const downMbps = s.throughput_down_mbps || 0;
    const upMbps = s.throughput_up_mbps || 0;
    document.getElementById('throughput-down').textContent = downMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-up').textContent = upMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-down-bar').style.width = Math.min(100, downMbps) + '%';
    document.getElementById('throughput-up-bar').style.width = Math.min(100, upMbps * 2) + '%';
    
    // Session uptime
    if (s.run_id) {
        const parts = s.run_id.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
        const start = parts ? new Date(parts[1], parts[2]-1, parts[3], parts[4], parts[5], parts[6]) : new Date();
        const now = new Date();
        const mins = Math.floor((now - start) / 60000);
        const hrs = Math.floor(mins / 60);
        document.getElementById('stat-uptime').textContent = hrs + 'h ' + (mins % 60) + 'm';
    }
}
</script>
<script>
// Map init
const map = L.map('map').setView([32.7767, -96.7970], 13);  // Dallas default
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '¬© OSM ¬© CARTO', maxZoom: 19
}).addTo(map);
let posMarker = null;
let trail = [];
const trailLine = L.polyline([], {color: '#00d4ff', weight: 2, opacity: 0.6}).addTo(map);

// Heatmap layer
let heatLayer = null;
async function loadHeatmap() {
    try {
        const resp = await fetch("/api/heatmap?hours=720");
        const data = await resp.json();
        if (data && data.length > 0) {
            const points = data.map(p => [p.lat, p.lng, Math.min(p.rtt/50, 1)]);
            if (heatLayer) map.removeLayer(heatLayer);
            heatLayer = L.heatLayer(points, {radius:20, blur:15, maxZoom:17}).addTo(map);
            console.log("Heatmap loaded:", data.length, "points");
        }
    } catch(e) { console.log("Heatmap error:", e); }
}
setTimeout(loadHeatmap, 2000);
setInterval(loadHeatmap, 30000);

// Signal markers with popups
let markerLayer = null;
const uplinkColors = {
    "cell_a": "#E20074",  // T-Mobile magenta
    "cell_b": "#00A8E0",  // AT&T blue
    "sl_a": "#1DA1F2",    // Starlink
    "sl_b": "#1DA1F2",
    "fa": "#00ff88",      // Fiber green
    "fb": "#00ff88",
    "fiber2": "#00ff88"
};
async function loadMarkers() {
    try {
        const resp = await fetch("/api/heatmap?hours=720");
        const data = await resp.json();
        if (markerLayer) map.removeLayer(markerLayer);
        const markers = data.filter(p => ["cell_a","cell_b","sl_a","sl_b"].includes(p.uplink)).slice(-200).map(p => {
            const color = uplinkColors[p.uplink] || "#fff";
            return L.circleMarker([p.lat, p.lng], {
                radius: 5, fillColor: color, color: "#000", 
                weight: 1, fillOpacity: 0.7
            }).bindPopup(
                "<b>" + p.uplink + "</b><br>" +
                "RTT: " + (p.rtt||0).toFixed(1) + "ms<br>" +
                "RSRP: " + (p.rsrp||0) + "<br>" +
                "SINR: " + (p.sinr||0)
            );
        });
        markerLayer = L.layerGroup(markers).addTo(map);
    } catch(e) { console.log("Marker error:", e); }
}
setTimeout(loadMarkers, 3000);
setInterval(loadMarkers, 30000);

// Sparkline data
const sparkData = {};


// Signal bar helper
function getSignalBars(rsrp) {
    const bars = 4;
    let active = 0;
    let cls = 'active';
    if (rsrp >= -80) { active = 4; cls = 'active'; }
    else if (rsrp >= -90) { active = 3; cls = 'active'; }
    else if (rsrp >= -100) { active = 2; cls = 'warn'; }
    else if (rsrp >= -110) { active = 1; cls = 'bad'; }
    else { active = 0; cls = 'bad'; }
    
    let html = '<span class="signal-bars">';
    for (let i = 0; i < bars; i++) {
        html += `<span class="signal-bar ${i < active ? cls : ''}"></span>`;
    }
    html += '</span>';
    return html;
}


// Signal bar helper
function getSignalBars(rsrp) {
    const bars = 4;
    let active = 0;
    let cls = 'active';
    if (rsrp >= -80) { active = 4; cls = 'active'; }
    else if (rsrp >= -90) { active = 3; cls = 'active'; }
    else if (rsrp >= -100) { active = 2; cls = 'warn'; }
    else if (rsrp >= -110) { active = 1; cls = 'bad'; }
    else { active = 0; cls = 'bad'; }
    
    let html = '<span class="signal-bars">';
    for (let i = 0; i < bars; i++) {
        html += `<span class="signal-bar ${i < active ? cls : ''}"></span>`;
    }
    html += '</span>';
    return html;
}

function renderUplinks(uplinks) {
    const container = document.getElementById('uplinks');
    container.innerHTML = '';
    
    uplinks.forEach(u => {
        
        const typeClass = u.name.startsWith('cell') ? 'lte' : 
                         u.name.startsWith('sl') ? 'starlink' : 'fiber';
        const carrierClass = u.cellular?.carrier === 'AT&T' ? 'att' : '';
        const activeClass = u.active ? 'active' : '';
        const availClass = u.available ? '' : 'unavailable';
        
        // Update sparkline data
        if (!sparkData[u.name]) sparkData[u.name] = [];
        sparkData[u.name].push(u.rtt_ms || 0);
        if (sparkData[u.name].length > 30) sparkData[u.name].shift();
        
        let metricsHtml = '';
        if (u.name.startsWith('cell')) {
            metricsHtml = `
                <div class="metric"><div class="metric-label">RTT</div><div class="metric-value ${u.rtt_ms > 100 ? 'warn' : ''}">${(u.rtt_ms||0).toFixed(0)}ms</div></div>
                <div class="metric"><div class="metric-label">RSRP${getSignalBars(u.cellular?.rsrp||0)}</div><div class="metric-value ${(u.cellular?.rsrp||0) < -100 ? 'warn' : ''}">${(u.cellular?.rsrp||0).toFixed(0)}</div></div>
                <div class="metric"><div class="metric-label">SINR</div><div class="metric-value">${(u.cellular?.sinr||0).toFixed(1)}</div></div>
                <div class="metric"><div class="metric-label">Loss</div><div class="metric-value ${u.loss_pct > 2 ? 'bad' : ''}">${(u.loss_pct||0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">Carrier</div><div class="metric-value">${u.cellular?.carrier||'--'}</div></div>
                <div class="metric"><div class="metric-label">Risk</div><div class="metric-value ${u.risk_now > 0.5 ? 'warn' : ''}">${((u.risk_now||0)*100).toFixed(0)}%</div></div>
            `;
        } else if (u.name.startsWith('sl')) {
            metricsHtml = `
                <div class="metric"><div class="metric-label">RTT</div><div class="metric-value ${u.rtt_ms > 80 ? 'warn' : ''}">${(u.rtt_ms||0).toFixed(0)}ms</div></div>
                <div class="metric"><div class="metric-label">State</div><div class="metric-value">${u.starlink?.state?.slice(0,6)||'--'}</div></div>
                <div class="metric"><div class="metric-label">OBSTR<span class="obstr-indicator ${u.starlink?.obstruction_pct > 5 ? 'obstructed' : 'clear'}"></span></div><div class="metric-value ${u.starlink?.obstructed ? 'bad' : ''}">${(u.starlink?.obstruction_pct || 0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">Loss</div><div class="metric-value ${u.loss_pct > 2 ? 'bad' : ''}">${(u.loss_pct||0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">ETA</div><div class="metric-value">${u.starlink?.eta > 0 ? u.starlink.eta + 's' : '--'}</div></div>
                <div class="metric"><div class="metric-label">Risk</div><div class="metric-value ${u.risk_now > 0.5 ? 'warn' : ''}">${((u.risk_now||0)*100).toFixed(0)}%</div></div>
            `;
        } else {
            metricsHtml = `
                <div class="metric"><div class="metric-label">RTT</div><div class="metric-value">${(u.rtt_ms||0).toFixed(0)}ms</div></div>
                <div class="metric"><div class="metric-label">Loss</div><div class="metric-value">${(u.loss_pct||0).toFixed(1)}%</div></div>
                <div class="metric"><div class="metric-label">Risk</div><div class="metric-value">${((u.risk_now||0)*100).toFixed(0)}%</div></div>
            `;
        }
        
        // Sparkline bars
        const sparkHtml = sparkData[u.name].map(v => {
            const h = Math.max(1, Math.min(14, v / 10));
            const cls = v > 150 ? 'bad' : v > 80 ? 'warn' : '';
            return `<div class="spark-bar ${cls}" style="height:${h}px"></div>`;
        }).join('');
        
        const card = document.createElement('div');
        card.className = `uplink-card ${typeClass} ${carrierClass} ${activeClass} ${availClass}`;
        card.innerHTML = `
            <div class="uplink-header">
                <span class="uplink-name">${u.name.toUpperCase()}</span>
                <div style="display:flex;align-items:center;gap:8px">
                    <span class="uplink-type">${typeClass}</span>
                    <div class="uplink-toggle ${u.enabled !== false ? 'enabled' : ''}" onclick="toggleUplink('${u.name}')" title="Toggle uplink"></div>
                </div>
            </div>
            <div class="metrics-grid">${metricsHtml}</div>
            <div class="sparkline">${sparkHtml}</div>
            <div class="uplink-actions">
                <button class="btn-fail" onclick="forceFail('${u.name}')">FORCE FAIL</button>
                <button class="btn-fail" style="border-color:var(--blue);color:var(--blue)" onclick="forceSwitch('${u.name}')">FORCE ACTIVE</button>
            </div>
        `;
        container.appendChild(card);
    });
}

function updateStatus(s) {
    // Mode badge
    const modeBadge = document.getElementById('mode-badge');
    modeBadge.textContent = s.mode || 'OFFLINE';
    modeBadge.className = 'badge mode-' + (s.mode || 'offline').toLowerCase();
    
    // State badge  
    const stateBadge = document.getElementById('state-badge');
    stateBadge.textContent = s.state || 'OFFLINE';
    stateBadge.className = 'badge state-' + (s.state || 'offline').toLowerCase();
    
    // Training banner
    document.getElementById('training-banner').classList.toggle('active', s.mode === 'TRAINING');
    
    // Speed
    document.getElementById('speed-val').textContent = Math.round(s.gps?.speed_mph || 0);
    
    // Node ID
    document.getElementById('node-id').textContent = s.node_id || '--';
    document.getElementById('run-id').textContent = s.run_id || '--';
    
    // Duplication
    document.getElementById('dup-status').textContent = s.dup_enabled ? 'ON' : 'OFF';
    document.getElementById('dup-status').style.color = s.dup_enabled ? 'var(--orange)' : 'var(--muted)';
    
    // Countdown panel
    const inProtection = ['PROTECT', 'SWITCHING', 'HOLDING'].includes(s.state);
    document.getElementById('countdown-panel').classList.toggle('active', inProtection);
    if (inProtection) {
        document.getElementById('trigger-reason').textContent = s.trigger || '--';
        document.getElementById('cd-hold').textContent = s.hold_remaining || 0;
        document.getElementById('cd-clean').textContent = s.clean_remaining || 0;
        document.getElementById('cd-switches').textContent = s.switches_this_window || 0;
    }
    
    // Flap banner
    document.getElementById('flap-banner').classList.toggle('active', s.flap_suppressed);
    
    // Risk
    const riskPct = Math.round((s.global_risk || 0) * 100);
    document.getElementById('risk-pct').textContent = riskPct + '%';
    document.getElementById('risk-pct').style.color = riskPct > 60 ? 'var(--red)' : riskPct > 30 ? 'var(--yellow)' : 'var(--green)';
    document.getElementById('risk-fill').style.width = riskPct + '%';
    
    const recEl = document.getElementById('risk-rec');
    recEl.textContent = s.recommendation || 'NORMAL';
    if (s.recommendation === 'PROTECT') {
        recEl.style.background = 'rgba(255,102,0,0.2)';
        recEl.style.color = 'var(--orange)';
    } else if (s.recommendation === 'PREPARE') {
        recEl.style.background = 'rgba(255,170,0,0.2)';
        recEl.style.color = 'var(--yellow)';
    } else {
        recEl.style.background = 'rgba(0,255,136,0.2)';
        recEl.style.color = 'var(--green)';
    }
    
    // GPS
    if (s.gps?.valid) {
        document.getElementById('gps-coords').textContent = 
            s.gps.lat.toFixed(6) + ', ' + s.gps.lon.toFixed(6);
        document.getElementById('gps-heading').textContent = Math.round(s.gps.heading || 0);
        document.getElementById('gps-alt').textContent = Math.round(s.gps.alt || 0);
        
        const latlng = [s.gps.lat, s.gps.lon];
        if (posMarker) {
            posMarker.setLatLng(latlng);
        } else {
            posMarker = L.circleMarker(latlng, {
                radius: 8, fillColor: '#00d4ff', fillOpacity: 1, 
                color: '#fff', weight: 2
            }).addTo(map);
            map.setView(latlng, 15);
        }
        
        // Trail
        trail.push(latlng);
        if (trail.length > 500) trail.shift();
        trailLine.setLatLngs(trail);
    }
    
    // Controller
    document.getElementById('ctrl-active').textContent = 
        s.active_controller === 0 ? 'Controller A' : 'Controller B';
    
    // Uplinks
    if (s.uplinks) {
        renderUplinks(s.uplinks);
    }
    
    // Mode buttons
    ['training', 'tripwire', 'mirror'].forEach(m => {
        document.getElementById('btn-' + m).classList.toggle('active', 
            s.mode?.toLowerCase() === m);
    });
}

function addFeedItem(type, msg, reason) {
    const feed = document.getElementById('feed');
    const now = new Date();
    const ts = now.toTimeString().split(' ')[0] + '.' + 
               String(now.getMilliseconds()).padStart(3, '0');
    
    const item = document.createElement('div');
    item.className = 'feed-item ' + type;
    item.innerHTML = `
        <div class="feed-time">${ts}</div>
        <div class="feed-msg">${msg}${reason ? ' <span class="feed-reason">[' + reason + ']</span>' : ''}</div>
    `;
    feed.insertBefore(item, feed.firstChild);
    if (feed.children.length > 100) feed.removeChild(feed.lastChild);
}

// API calls
async function setMode(mode) {
    await fetch('/api/control/mode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode})
    });
    addFeedItem('mode', 'Mode changed to ' + mode.toUpperCase());
}

async function forceSwitch(uplink) {
    await fetch('/api/control/force', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uplink})
    });
    addFeedItem('switch', 'Manual switch to ' + uplink.toUpperCase());
}

async function forceFail(uplink) {
    console.log("forceFail called:", uplink);
    await fetch('/api/control/fail', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uplink})
    });
    addFeedItem('tripwire', 'Force fail on ' + uplink.toUpperCase(), 'manual');
}

async function triggerProtection() {
    await fetch('/api/control/trigger', {method: 'POST'});
    addFeedItem('tripwire', 'Manual protection trigger', 'operator');
}

async function switchController(ctrl) {
    await fetch('/api/control/controller', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({controller: ctrl})
    });
    addFeedItem('switch', 'Controller switch to ' + (ctrl === 0 ? 'A' : 'B'));
}

// SSE connection
let lastState = '';
const evtSource = new EventSource('/api/stream');
evtSource.onmessage = (e) => {
    const status = JSON.parse(e.data);
    
    // Detect state changes for feed
    if (status.state !== lastState && lastState) {
        if (status.state === 'PROTECT') {
            addFeedItem('tripwire', 'Protection activated', status.trigger);
        } else if (status.state === 'NORMAL' && lastState !== 'NORMAL') {
            addFeedItem('predict', 'Returned to normal operation');
        }
    }
    lastState = status.state;
    
    checkStateChanges(status);
    updateStatus(status);
    updateStats(status);
};
evtSource.onerror = () => {
    console.log('SSE reconnecting...');
};

// Initial load
fetch('/api/status').then(r => r.json()).then(updateStatus).catch(() => {});

// Event Log
const eventLog = [];
let logFilter = "all";

function addLogEntry(level, msg, gps) {
    const now = new Date();
    const ts = now.toTimeString().split(" ")[0] + "." + String(now.getMilliseconds()).padStart(3, "0");
    const entry = { time: ts, level, msg, gps: gps || null, timestamp: now };
    eventLog.push(entry);
    if (eventLog.length > 500) eventLog.shift();
    renderLog();
}

function renderLog() {
    const container = document.getElementById("event-log-content");
    const filtered = logFilter === "all" ? eventLog : eventLog.filter(e => e.level === logFilter);
    container.innerHTML = filtered.slice(-100).map(e => `
        <div class="log-entry">
            <span class="log-time">${e.time}</span>
            <span class="log-level ${e.level}">${e.level.toUpperCase()}</span>
            <span class="log-msg">${e.msg}</span>
            ${e.gps ? `<span class="log-gps">[${e.gps}]</span>` : ""}
        </div>
    `).join("");
    container.scrollTop = container.scrollHeight;
}

function filterLog(filter) {
    logFilter = filter;
    document.querySelectorAll(".event-log-controls button").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    renderLog();
}

function exportLog() {
    const csv = "Time,Level,Message,GPS\n" + eventLog.map(e =>
        `${e.time},${e.level},"${e.msg}",${e.gps||""}`
    ).join("\n");
    const blob = new Blob([csv], {type: "text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "pathsteer_log_" + new Date().toISOString().slice(0,19).replace(/:/g,"-") + ".csv";
    a.click();
}

// Log state changes
let prevState = null, prevMode = null, prevActive = null;
function checkStateChanges(s) {
    const gps = s.gps?.valid ? `${s.gps.lat.toFixed(5)},${s.gps.lon.toFixed(5)}` : null;
    if (prevState !== s.state && prevState !== null) {
        if (s.state === "PROTECT") addLogEntry("trigger", `TRIPWIRE fired: ${s.trigger}`, gps);
        else if (s.state === "SWITCHING") addLogEntry("warn", "Executing path switch", gps);
        else if (s.state === "HOLDING") addLogEntry("switch", `Switched to ${s.active_uplink}`, gps);
        else if (s.state === "NORMAL") addLogEntry("info", "Returned to NORMAL", gps);
    }
    if (prevMode !== s.mode && prevMode !== null) addLogEntry("info", `Mode changed to ${s.mode}`, gps);
    if (prevActive !== s.active_uplink && prevActive !== null) addLogEntry("switch", `Active uplink: ${prevActive} ‚Üí ${s.active_uplink}`, gps);
    prevState = s.state; prevMode = s.mode; prevActive = s.active_uplink;
}

// Startup log
addLogEntry("info", "PathSteer Guardian UI connected");

// Update stats from status
function updateStats(s) {
    // Find best/worst RTT
    const available = (s.uplinks || []).filter(u => u.enabled && u.available);
    if (available.length > 0) {
        const sorted = [...available].sort((a,b) => (a.rtt_ms||999) - (b.rtt_ms||999));
        document.getElementById('stat-best-path').textContent = sorted[0].name.toUpperCase() + ' (' + (sorted[0].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-worst-path').textContent = sorted[sorted.length-1].name.toUpperCase() + ' (' + (sorted[sorted.length-1].rtt_ms||0).toFixed(0) + 'ms)';
        document.getElementById('stat-diversity').textContent = available.length + '/' + (s.uplinks||[]).filter(u=>u.enabled).length;
    }
    
    // Throughput (placeholder - would come from actual traffic stats)
    const downMbps = s.throughput_down_mbps || 0;
    const upMbps = s.throughput_up_mbps || 0;
    document.getElementById('throughput-down').textContent = downMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-up').textContent = upMbps.toFixed(1) + ' Mbps';
    document.getElementById('throughput-down-bar').style.width = Math.min(100, downMbps) + '%';
    document.getElementById('throughput-up-bar').style.width = Math.min(100, upMbps * 2) + '%';
    
    // Session uptime
    if (s.run_id) {
        const parts = s.run_id.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
        const start = parts ? new Date(parts[1], parts[2]-1, parts[3], parts[4], parts[5], parts[6]) : new Date();
        const now = new Date();
        const mins = Math.floor((now - start) / 60000);
        const hrs = Math.floor(mins / 60);
        document.getElementById('stat-uptime').textContent = hrs + 'h ' + (mins % 60) + 'm';
    }
}

// Toggle uplink enabled
async function toggleUplink(name) {
    const resp = await fetch('/api/uplink/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name})
    });
    const data = await resp.json();
    console.log('Toggled', name, data);
}

/* Load event history from database */
async function loadEventHistory() {
    try {
        const resp = await fetch("/api/events/history?limit=50");
        const events = await resp.json();
        const feed = document.getElementById("feed");
        events.reverse().forEach(e => {
            const ts = e.timestamp ? e.timestamp.split(" ")[1] || e.timestamp.substring(11,19) : "";
            const item = document.createElement("div");
            item.className = "feed-item " + e.type;
            item.innerHTML = `<div class="feed-time">${ts}</div><div class="feed-msg">${e.message}${e.detail ? " <span class=\"feed-reason\">[" + e.detail + "]</span>" : ""}</div>`;
            feed.appendChild(item);
        });
    } catch(err) { console.log("Could not load event history:", err); }
}

/* Load event history on page load */
loadEventHistory();
</script>
</body>
</html>
